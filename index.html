<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECrew Absensi Transwisata Prima Aviation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 2rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 2rem;
        }
        .btn {
            @apply px-6 py-3 rounded-full font-semibold transition-transform duration-200 transform hover:scale-105;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Kontainer Utama Aplikasi -->
    <div id="app-container" class="w-full max-w-4xl">

        <!-- Header Aplikasi -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">ECrew Absensi</h1>
            <h2 class="text-lg sm:text-xl text-gray-600 mt-2">Transwisata Prima Aviation</h2>
        </header>

        <!-- Halaman Login -->
        <div id="login-page" class="card mx-auto max-w-md">
            <h3 class="text-2xl font-bold text-center mb-6 text-gray-800">Masuk</h3>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-gray-700 font-medium mb-2">Username</label>
                    <input type="text" id="username" name="username" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan username" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 font-medium mb-2">Password</label>
                    <input type="password" id="password" name="password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan password" required>
                </div>
                <button type="submit" class="btn w-full bg-blue-600 text-white hover:bg-blue-700">Login</button>
            </form>
            <div id="login-message" class="mt-4 text-center text-red-500 font-medium hidden"></div>
        </div>

        <!-- Dashboard Pengguna -->
        <div id="user-dashboard" class="card hidden">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-2 sm:mb-0">Selamat Datang, <span id="user-name"></span>!</h3>
                <button id="logout-btn" class="btn bg-gray-200 text-gray-700 hover:bg-gray-300">Logout</button>
            </div>
            
            <!-- Menu Absensi -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                <div class="bg-blue-100 p-6 rounded-xl flex flex-col items-center justify-center">
                    <h4 class="text-xl font-semibold mb-4 text-blue-800">Absensi Hari Ini</h4>
                    <button id="clock-in-btn" class="btn bg-green-500 text-white w-full sm:w-auto hover:bg-green-600 mb-2">Clock In</button>
                    <button id="clock-out-btn" class="btn bg-red-500 text-white w-full sm:w-auto hover:bg-red-600">Clock Out</button>
                    <p id="status-absensi" class="mt-4 text-center text-gray-600 font-medium"></p>
                </div>
                <div class="bg-yellow-100 p-6 rounded-xl">
                    <h4 class="text-xl font-semibold mb-4 text-yellow-800">Berita Terkini</h4>
                    <div id="news-container" class="space-y-4">
                        <!-- Konten berita akan dimuat di sini -->
                    </div>
                </div>
            </div>

            <!-- Riwayat Absensi -->
            <div class="bg-gray-50 p-6 rounded-xl">
                <h4 class="text-xl font-semibold text-gray-800 mb-4">Riwayat Absensi</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-left table-auto">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700">
                                <th class="p-4 rounded-tl-lg">Tanggal</th>
                                <th class="p-4">Clock In</th>
                                <th class="p-4 rounded-tr-lg">Clock Out</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-history-table">
                            <!-- Riwayat akan dimuat di sini -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Dashboard Admin -->
        <div id="admin-dashboard" class="card hidden">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-2 sm:mb-0">Dashboard Admin</h3>
                <button id="admin-logout-btn" class="btn bg-gray-200 text-gray-700 hover:bg-gray-300">Logout</button>
            </div>
            <div class="bg-gray-50 p-6 rounded-xl">
                <h4 class="text-xl font-semibold text-gray-800 mb-4">Data Absensi Seluruh Karyawan</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-left table-auto">
                        <thead>
                            <tr class="bg-gray-200 text-gray-700">
                                <th class="p-4 rounded-tl-lg">Nama</th>
                                <th class="p-4">Tanggal</th>
                                <th class="p-4">Clock In</th>
                                <th class="p-4 rounded-tr-lg">Clock Out</th>
                            </tr>
                        </thead>
                        <tbody id="admin-data-table">
                            <!-- Data absensi akan dimuat di sini -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Modals and Loaders -->
        <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
                <p id="loading-text" class="mt-4 text-gray-700 font-medium">Memuat...</p>
            </div>
        </div>

    </div>

    <script>
        // Data pengguna dan admin yang disimulasikan
        const users = {
            'user1': { password: 'user123', name: 'John Doe', role: 'user' },
            'admin1': { password: 'admin123', name: 'Jane Smith', role: 'admin' }
        };

        // Data absensi yang disimulasikan
        let attendanceData = [
            { id: 'user1', name: 'John Doe', date: '2023-10-25', clockIn: '08:00', clockOut: '17:00' },
            { id: 'user1', name: 'John Doe', date: '2023-10-26', clockIn: '08:05', clockOut: '17:02' },
            { id: 'user1', name: 'John Doe', date: '2023-10-27', clockIn: '08:01', clockOut: null }, // Absensi hari ini
            { id: 'user2', name: 'Alice', date: '2023-10-27', clockIn: '08:15', clockOut: '17:30' },
            { id: 'user3', name: 'Bob', date: '2023-10-27', clockIn: '07:55', clockOut: '16:45' }
        ];

        // Data berita yang disimulasikan
        const newsData = [
            { title: 'Jadwal Penerbangan Baru ke Destinasi Populer', content: 'Transwisata Prima Aviation mengumumkan pembukaan rute baru untuk meningkatkan layanan.' },
            { title: 'Pelatihan Keselamatan Pesawat Generasi Terbaru', content: 'Seluruh kru akan mengikuti pelatihan komprehensif untuk pesawat seri A380.' },
            { title: 'Penghargaan Maskapai Paling Tepat Waktu', content: 'Maskapai kita kembali meraih penghargaan atas kinerja ketepatan waktu terbaik.' },
        ];
        
        // Elemen DOM
        const appContainer = document.getElementById('app-container');
        const loginPage = document.getElementById('login-page');
        const userDashboard = document.getElementById('user-dashboard');
        const adminDashboard = document.getElementById('admin-dashboard');
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginMessage = document.getElementById('login-message');
        const logoutBtn = document.getElementById('logout-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const userNameSpan = document.getElementById('user-name');
        const clockInBtn = document.getElementById('clock-in-btn');
        const clockOutBtn = document.getElementById('clock-out-btn');
        const statusAbsensi = document.getElementById('status-absensi');
        const attendanceHistoryTable = document.getElementById('attendance-history-table');
        const adminDataTable = document.getElementById('admin-data-table');
        const newsContainer = document.getElementById('news-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        
        let currentUser = null;

        // URL dari Google Apps Script yang akan Anda deploy
        // GANTI DENGAN URL MILIK ANDA SETELAH DEPLOY SKRIP!
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbygVnLNWsQ2_2LAQNZUSobUlp-eXUkRygE1LbbLN2P8vzcabCR4OZcPWHfVZOXKIsaR_A/exec';

        // Fungsi untuk menampilkan halaman
        function showPage(pageId) {
            const pages = [loginPage, userDashboard, adminDashboard];
            pages.forEach(page => {
                if (page.id === pageId) {
                    page.classList.remove('hidden');
                } else {
                    page.classList.add('hidden');
                }
            });
        }

        // Fungsi untuk menampilkan overlay loading
        function showLoader(message = 'Memuat...') {
            loadingText.textContent = message;
            loadingOverlay.classList.remove('hidden');
        }

        // Fungsi untuk menyembunyikan overlay loading
        function hideLoader() {
            loadingOverlay.classList.add('hidden');
        }

        // Fungsi untuk melakukan panggilan API ke Google Apps Script
        async function callApi(action, data = {}) {
            const payload = { action, ...data };
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Penting untuk menghindari masalah CORS
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                return { success: false, message: 'Terjadi kesalahan saat menghubungi server.' };
            }
        }

        // Event listener untuk form login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            
            showLoader('Sedang login...');

            // Ganti simulateApiCall dengan callApi
            const response = await callApi('login', { username, password });
            hideLoader();

            if (response.success) {
                currentUser = response.user;
                if (currentUser.role === 'user') {
                    showPage('user-dashboard');
                    userNameSpan.textContent = currentUser.name;
                    loadUserDashboard();
                } else if (currentUser.role === 'admin') {
                    showPage('admin-dashboard');
                    loadAdminDashboard();
                }
            } else {
                loginMessage.textContent = response.message;
                loginMessage.classList.remove('hidden');
            }
        });

        // Fungsi untuk memuat data dashboard pengguna
        async function loadUserDashboard() {
            // Cek jika pengguna belum login
            if (!currentUser) return;
            
            // Load status absensi hari ini
            const today = new Date().toISOString().slice(0, 10);
            const recordToday = attendanceData.find(rec => rec.id === currentUser.id && rec.date === today);
            if (recordToday) {
                if (recordToday.clockOut) {
                    statusAbsensi.textContent = `Anda sudah Clock In dan Clock Out hari ini.`;
                    clockInBtn.disabled = true;
                    clockOutBtn.disabled = true;
                    clockInBtn.classList.add('opacity-50');
                    clockOutBtn.classList.add('opacity-50');
                } else {
                    statusAbsensi.textContent = `Anda sudah Clock In hari ini pada pukul ${recordToday.clockIn}.`;
                    clockInBtn.disabled = true;
                    clockInBtn.classList.add('opacity-50');
                }
            } else {
                statusAbsensi.textContent = `Anda belum melakukan absensi hari ini.`;
                clockOutBtn.disabled = true;
                clockOutBtn.classList.add('opacity-50');
            }

            // Muat riwayat absensi
            // Ganti simulateApiCall dengan callApi
            const response = await callApi('getUserAttendance', { userId: currentUser.id });
            if (response.success) {
                renderAttendanceHistory(response.data);
            }
            
            // Muat berita
            renderNews();
        }

        // Fungsi untuk memuat data dashboard admin
        async function loadAdminDashboard() {
            // Cek jika pengguna belum login
            if (!currentUser) return;

            showLoader('Mengambil data absensi...');
            // Ganti simulateApiCall dengan callApi
            const response = await callApi('getAllAttendance');
            hideLoader();
            if (response.success) {
                renderAdminData(response.data);
            }
        }

        // Fungsi untuk merender riwayat absensi pengguna
        function renderAttendanceHistory(data) {
            attendanceHistoryTable.innerHTML = '';
            if (data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="3" class="text-center p-4 text-gray-500">Belum ada riwayat absensi.</td>`;
                attendanceHistoryTable.appendChild(row);
                return;
            }
            data.sort((a, b) => new Date(b.date) - new Date(a.date));
            data.forEach(record => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-gray-200');
                const clockOutText = record.clockOut ? record.clockOut : '<span class="text-gray-400">Belum absensi</span>';
                row.innerHTML = `
                    <td class="p-4">${record.date}</td>
                    <td class="p-4">${record.clockIn}</td>
                    <td class="p-4">${clockOutText}</td>
                `;
                attendanceHistoryTable.appendChild(row);
            });
        }

        // Fungsi untuk merender data absensi admin
        function renderAdminData(data) {
            adminDataTable.innerHTML = '';
            if (data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4" class="text-center p-4 text-gray-500">Belum ada data absensi.</td>`;
                adminDataTable.appendChild(row);
                return;
            }
            data.sort((a, b) => new Date(b.date) - new Date(a.date));
            data.forEach(record => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-gray-200');
                const clockOutText = record.clockOut ? record.clockOut : '<span class="text-gray-400">Belum Clock Out</span>';
                row.innerHTML = `
                    <td class="p-4">${record.name}</td>
                    <td class="p-4">${record.date}</td>
                    <td class="p-4">${record.clockIn}</td>
                    <td class="p-4">${clockOutText}</td>
                `;
                adminDataTable.appendChild(row);
            });
        }

        // Fungsi untuk merender berita terkini
        function renderNews() {
            newsContainer.innerHTML = '';
            newsData.forEach(news => {
                const newsItem = document.createElement('div');
                newsItem.classList.add('bg-white', 'p-4', 'rounded-lg', 'shadow-sm', 'border-l-4', 'border-yellow-500');
                newsItem.innerHTML = `
                    <h5 class="text-md font-semibold text-gray-800">${news.title}</h5>
                    <p class="text-sm text-gray-600 mt-1">${news.content}</p>
                `;
                newsContainer.appendChild(newsItem);
            });
        }

        // Event listener untuk tombol Clock In
        clockInBtn.addEventListener('click', async () => {
            showLoader('Clock In...');
            // Ganti simulateApiCall dengan callApi
            const response = await callApi('clockIn', { userId: currentUser.id, userName: currentUser.name });
            hideLoader();
            if (response.success) {
                statusAbsensi.textContent = `Clock In berhasil! Waktu: ${new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`;
                clockInBtn.disabled = true;
                clockOutBtn.disabled = false;
                clockInBtn.classList.add('opacity-50');
                clockOutBtn.classList.remove('opacity-50');
                loadUserDashboard();
            } else {
                statusAbsensi.textContent = response.message;
            }
        });
        
        // Event listener untuk tombol Clock Out
        clockOutBtn.addEventListener('click', async () => {
            showLoader('Clock Out...');
            // Ganti simulateApiCall dengan callApi
            const response = await callApi('clockOut', { userId: currentUser.id });
            hideLoader();
            if (response.success) {
                statusAbsensi.textContent = `Clock Out berhasil! Waktu: ${new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`;
                clockInBtn.disabled = true;
                clockOutBtn.disabled = true;
                clockInBtn.classList.add('opacity-50');
                clockOutBtn.classList.add('opacity-50');
                loadUserDashboard();
            } else {
                statusAbsensi.textContent = response.message;
            }
        });
        
        // Event listener untuk tombol logout
        logoutBtn.addEventListener('click', () => {
            currentUser = null;
            loginMessage.classList.add('hidden');
            loginForm.reset();
            showPage('login-page');
            clockInBtn.disabled = false;
            clockOutBtn.disabled = true;
            clockInBtn.classList.remove('opacity-50');
            clockOutBtn.classList.add('opacity-50');
        });
        
        adminLogoutBtn.addEventListener('click', () => {
            currentUser = null;
            loginMessage.classList.add('hidden');
            loginForm.reset();
            showPage('login-page');
        });
        
    </script>
</body>
</html>
