<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecrew Absensi Karyawan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Global variables for Firebase and App
        let db, auth, storage, userId;
        let userProfile = null;
        let isAuthReady = false;
        let todayAbsenceDocRef = null;

        // --- Hardcoded User Data (Simulates "USER" sheet) ---
        const users = [
            { name: "Rustam Suhanda", email: "managementtranswisata@gmail.com", division: "Staf", position: "President Director", role: "USER", password: "rustam" },
            { name: "Selfy Warauw", email: "warauw_1@yahoo.com", division: "Staf", position: "Director", role: "USER", password: "selfy" },
            { name: "Muhamad Ramdani Masri", email: "crunkbolcow@gmail.com", division: "Operation", position: "Chief Pilot Rotary Wing", role: "USER", password: "muhamad" },
            { name: "Sulaksono Teddy Prabowo", email: "fly5103@gmail.com", division: "Operation", position: "Line Pilot", role: "USER", password: "sulaksono" },
            { name: "Marcelino Bhaharoenawanto", email: "marcelino412ep@gmail.com", division: "Operation", position: "Line Pilot", role: "USER", password: "marcelino" },
            { name: "Muhamad Sofwan", email: "sofwanm819@gmail.com", division: "Operation", position: "Chief Pilot Fixed Wing", role: "USER", password: "muhamad" },
            { name: "Sofian M. L. Tobing", email: "sofiantobing692@gmail.com", division: "Operation", position: "General Manager", role: "USER", password: "sofian" },
            { name: "Rico Febdiandana", email: "ricofebdi@gmail.com", division: "Operation", position: "Chief Flight Support", role: "USER", password: "rico" },
            { name: "Alfajri", email: "alfajri_koto@yahoo.com", division: "Operation", position: "Line Pilot", role: "USER", password: "alfajri" },
            { name: "Eli Setya", email: "tioxpilot@gmail.com", division: "Operation", position: "Line Pilot", role: "USER", password: "Eli" },
            { name: "Susetyo Harijanto", email: "harijantosusetyo@gmail.com", division: "Operation", position: "Operation Manager", role: "USER", password: "susetyo" },
            { name: "Purwoko", email: "purwoko.mulyono@yahoo.com", division: "Operation", position: "Line Pilot", role: "USER", password: "purwoko" },
            { name: "Riza Hanindita", email: "icul2122@gmail.com", division: "Operation", position: "Line Pilot", role: "USER", password: "riza" },
            { name: "Henaldy Arifia Sudrajat", email: "henaldy.ts204@gmail.com", division: "Operation", position: "Line Pilot", role: "USER", password: "henaldy" },
            { name: "Kadek Amelia Nadya Berliana", email: "amelberliana@yahoo.co.id", division: "Operation", position: "Line Pilot", role: "USER", password: "kadek" },
            { name: "Qorry Maulidya Natawijaya", email: "qnatawijaya@gmail.com", division: "Operation", position: "Cabin Service", role: "USER", password: "qorry" },
            { name: "Tiffani Pricilia Hasan", email: "tiffanipriciliaaaa@gmail.com", division: "Operation", position: "Cabin Service", role: "USER", password: "tiffani" },
            { name: "Agustin Zulfani Prihatini", email: "agustinzulfani74@gmail.com", division: "Operation", position: "Cabin Service", role: "USER", password: "agustin" },
            { name: "Nadya Casey Ivanka", email: "ivankacasey99@gmail.com", division: "Operation", position: "Cabin Service", role: "USER", password: "nadya" },
            { name: "Yanu Prihatno", email: "prihatnoyanu@gmail.com", division: "Maintenance", position: "Engineer", role: "USER", password: "yanu" },
            { name: "Bayu Nugroho", email: "bayu.avicena@gmail.com", division: "Maintenance", position: "Engineer", role: "USER", password: "bayu" },
            { name: "Wahyudi Suseno", email: "nawawahyudisuseno090@gmail.com", division: "Maintenance", position: "Avionic", role: "USER", password: "wahyudi" },
            { name: "Sigit Hardadi", email: "sigithardadi88@yahoo.com", division: "Maintenance", position: "Engineer", role: "USER", password: "Sigit" },
            { name: "Hadi Sutrisno", email: "hadikamilatun@gmail.com", division: "Maintenance", position: "Maintenance Manager", role: "USER", password: "hadi" },
            { name: "Suhairi", email: "suhairitwa@gmail.com", division: "Maintenance", position: "Engineer", role: "USER", password: "suhairi" },
            { name: "Suyanto", email: "yanto.umardin@gmail.com", division: "Maintenance", position: "Avionic", role: "USER", password: "suyanto" },
            { name: "Lazarus Rio Raymond", email: "rioraymond89@gmail.com", division: "Maintenance", position: "Engineer", role: "USER", password: "lazarus" },
            { name: "Febie Aguti Effendi", email: "mpiipie@gmail.com", division: "Maintenance", position: "Engineer", role: "USER", password: "febie" },
            { name: "Diki Hariyanto", email: "dikiatnu7@gmail.com", division: "Maintenance", position: "Chief Engineer", role: "USER", password: "diki" },
            { name: "Prayit Susonggo", email: "prayitsusonggo@yahoo.com", division: "Maintenance", position: "Avionic", role: "USER", password: "prayit" },
            { name: "Iskandar Akbar Hakim", email: "iskandarakbarhakim@gmail.com", division: "Maintenance", position: "Chief Inspector", role: "USER", password: "iskandar" },
            { name: "Arif Vrybadi Halim", email: "GlexXRSvpcgo@outlook.com", division: "Maintenance", position: "Engineer", role: "USER", password: "arif" },
            { name: "Alfiza Eka Putra", email: "alfizaekap@gmail.com", division: "Maintenance", position: "Engineer", role: "USER", password: "alfiza" },
            { name: "Dedi Prasetyo", email: "deditren99@gmail.com", division: "Safety", position: "Aviation Security", role: "USER", password: "dedi" },
            { name: "Media H Marbun", email: "mediamarbun@gmail.com", division: "Staf", position: "Human Resource Development", role: "USER", password: "media" },
            { name: "Fatmawati", email: "ulieumeda@gmail.com", division: "Staf", position: "Finance", role: "USER", password: "fatmawati" },
            { name: "Dede Rahman Arafiq", email: "d2rahman@yahoo.co.id", division: "Staf", position: "Finance", role: "USER", password: "dede" },
            { name: "Leo Fitzgerald Sinay", email: "leosinay@gmail.com", division: "Maintenance", position: "Chief Engineering", role: "USER", password: "leo" },
            { name: "Khairul Zaman Pohan", email: "pohan16zaman@gmail.com", division: "Operation", position: "Flight Support", role: "USER", password: "khairul" },
            { name: "Sentot Basuki", email: "sentotbasuki@gmail.com", division: "Operation", position: "Flight Support", role: "USER", password: "sentot" },
            { name: "Bobby Feisal Mahardhika", email: "bobby.feisal22@gmail.com", division: "Staf", position: "Engineering", role: "USER", password: "bobby" },
            { name: "Tri Widayat", email: "tri3wiwid@gmail.com", division: "Operation", position: "Flight Support", role: "USER", password: "tri" },
            { name: "Isdarminto", email: "is.darminto35@gmail.com", division: "Staf", position: "Logistic", role: "USER", password: "isdarminto" },
            { name: "Sulaichan Noor Ali", email: "sulaichann @gmail.com", division: "Staf", position: "Logistic", role: "USER", password: "sulaichan" },
            { name: "Sri Muljono Bayu Putro", email: "sbayuputro@gmail.com", division: "Operation", position: "Flight Support", role: "USER", password: "sri" },
            { name: "Asri Gatot Yulianto", email: "Asrigatot.67@gmail.com", division: "Safety", position: "Aviation Security", role: "USER", password: "asri" },
            { name: "Nanang Chabibi", email: "nanangchabibi3@gmail.com", division: "Safety", position: "Aviation Security", role: "USER", password: "nanang" },
            { name: "Hariyanto", email: "katellisna423@gmail.com", division: "Safety", position: "Aviation Security", role: "USER", password: "hariyanto" },
            { name: "Supriyono", email: "fardhan0509@gmail.com", division: "Staf", position: "Kurir", role: "USER", password: "supriyono" },
            { name: "Kasna", email: "kasna.pjln799@gmail.com", division: "Staf", position: "Driver", role: "USER", password: "kasna" },
            { name: "Ardi Rizki", email: "ardi.rizk91@gmail.com", division: "Maintenance", position: "Engineer", role: "USER", password: "ardi" },
            { name: "Wawan Setiawan", email: "setiawanwawan7312@gmail.com", division: "Operation", position: "Line Pilot", role: "USER", password: "wawan" },
            { name: "Tommy Saputra", email: "tommysaputra473@gmail.com", division: "Staf", position: "Chief Finance, Accounting & Tax", role: "USER", password: "tommy" },
            { name: "Mochamad Riza", email: "mch_riza@yahoo.com", division: "Safety", position: "Quality, Safety, Security Manager", role: "USER", password: "mochamad" },
            { name: "Alexander Anggarda Yunan Devata", email: "alexanderdevata@yahoo.co.id", division: "Operation", position: "Flight Support", role: "USER", password: "alexander" },
            { name: "Sukyono", email: "sskkyy020@gmail.com", division: "Operation", position: "Flight Support", role: "USER", password: "sukyono" },
            { name: "Administrator", email: "admin@twa.com", division: "HRD", position: "IT", role: "ADMIN", password: "Admintwa021" }
        ];

        // --- Core Functions ---
        const showErrorModal = (message) => {
            const modal = document.getElementById('error-modal');
            document.getElementById('error-message').textContent = message;
            modal.classList.remove('hidden');
        };

        const hideErrorModal = () => {
            document.getElementById('error-modal').classList.add('hidden');
        };

        const showLoading = (message) => {
            const modal = document.getElementById('loading-modal');
            document.getElementById('loading-message').textContent = message;
            modal.classList.remove('hidden');
        };

        const hideLoading = () => {
            document.getElementById('loading-modal').classList.add('hidden');
        };

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // Haversine formula to calculate distance between two points on a sphere (earth)
        function haversineDistance(coords1, coords2) {
            const toRad = (x) => x * Math.PI / 180;
            const R = 6371; // Earth's radius in km
            const dLat = toRad(coords2.latitude - coords1.latitude);
            const dLon = toRad(coords2.longitude - coords1.longitude);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(toRad(coords1.latitude)) * Math.cos(toRad(coords2.latitude)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c * 1000; // Return distance in meters
        }

        const getGeoLocation = () => {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject('Geolocation tidak didukung oleh browser ini.');
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (position) => resolve(position.coords),
                    (error) => {
                        let errorMessage = 'Gagal mendapatkan lokasi.';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "Izin lokasi ditolak. Mohon izinkan akses lokasi untuk melanjutkan.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "Informasi lokasi tidak tersedia.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "Waktu tunggu untuk lokasi habis.";
                                break;
                            case error.UNKNOWN_ERROR:
                                errorMessage = "Terjadi kesalahan tidak dikenal.";
                                break;
                        }
                        reject(errorMessage);
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            });
        };

        // --- Firebase Initialization and Auth ---
        window.onload = async () => {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                if (Object.keys(firebaseConfig).length > 0) {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    storage = getStorage(app);

                    document.getElementById('app-id-display').textContent = appId;
                    showLoading('Memuat...');

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log('User authenticated:', userId);
                        } else {
                            userId = crypto.randomUUID(); // Fallback for testing
                            console.log('User not authenticated, using a temporary ID:', userId);
                        }
                        isAuthReady = true;
                        hideLoading();
                    });

                    if (typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } else {
                    showErrorModal('Firebase config tidak ditemukan.');
                }
            } catch (e) {
                console.error("Error during Firebase initialization:", e);
                showErrorModal('Gagal menginisialisasi Firebase. Coba muat ulang halaman.');
            }
        };

        // --- UI State Management ---
        const showLoginPage = () => {
            document.getElementById('loading-modal').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('attendance-page').classList.add('hidden');
        };

        const showAttendancePage = () => {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('attendance-page').classList.remove('hidden');
            setupAttendanceListener();
        };

        // --- Login Logic ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const foundUser = users.find(u => u.email === email && u.password === password);

            if (foundUser) {
                userProfile = foundUser;
                document.getElementById('profile-name').textContent = userProfile.name;
                document.getElementById('profile-email').textContent = userProfile.email;
                document.getElementById('profile-division').textContent = userProfile.division;
                document.getElementById('profile-position').textContent = userProfile.position;
                document.getElementById('profile-id').textContent = userId;
                showAttendancePage();
            } else {
                showErrorModal('Email atau kata sandi salah. Silakan coba lagi.');
            }
        });

        // --- Attendance Logic ---
        const setupAttendanceListener = () => {
            const today = new Date().toISOString().slice(0, 10);
            const attendanceCollectionRef = collection(db, `artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/public/data/absensi`);
            todayAbsenceDocRef = doc(attendanceCollectionRef, `${userId}-${today}`);

            onSnapshot(todayAbsenceDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('attendance-form').classList.remove('hidden');
                    document.getElementById('absensi-info').classList.remove('hidden');
                    
                    document.getElementById('absensi-name').textContent = data.name;
                    document.getElementById('absensi-email').textContent = data.email;
                    document.getElementById('absensi-division').textContent = data.division;
                    document.getElementById('absensi-position').textContent = data.position;
                    document.getElementById('absensi-duty').textContent = data.duty;
                    document.getElementById('absensi-work-type').textContent = data.typeOfWork;
                    document.getElementById('absensi-status').textContent = data.statusAbsen;
                    document.getElementById('absensi-date-in').textContent = data.dateMasuk;
                    document.getElementById('absensi-time-in').textContent = data.absenMasuk;
                    document.getElementById('absensi-status-in').textContent = data.statusMasuk;
                    document.getElementById('absensi-location-in').textContent = `Latitude: ${data.locationMasuk.latitude.toFixed(4)}, Longitude: ${data.locationMasuk.longitude.toFixed(4)}`;
                    document.getElementById('absensi-radius-in').textContent = data.radius;

                    if (data.statusMasuk === 'Anda Terlambat Absen') {
                        document.getElementById('absensi-reason').textContent = data.alasanTerlambat;
                        document.getElementById('late-reason-section').classList.remove('hidden');
                    } else {
                        document.getElementById('late-reason-section').classList.add('hidden');
                    }

                    document.getElementById('clock-in-section').classList.add('hidden');
                    document.getElementById('clock-out-section').classList.remove('hidden');
                    document.getElementById('remark-field').classList.remove('hidden');
                    document.getElementById('job-photo-field').classList.remove('hidden');

                    if (data.absenPulang) {
                        document.getElementById('absensi-time-out').textContent = data.absenPulang;
                        document.getElementById('absensi-status-out').textContent = data.statusPulang;
                        document.getElementById('absensi-total-worktime').textContent = data.totalWorktime;
                        document.getElementById('absensi-location-out').textContent = `Latitude: ${data.locationPulang.latitude.toFixed(4)}, Longitude: ${data.locationPulang.longitude.toFixed(4)}`;
                        document.getElementById('absensi-radius-out').textContent = data.radiusPulang;
                        
                        document.getElementById('clock-out-button-container').classList.add('hidden');
                        document.getElementById('total-overtime-row').classList.add('hidden');
                        if (data.totalOvertime) {
                            document.getElementById('absensi-total-overtime').textContent = data.totalOvertime;
                            document.getElementById('total-overtime-row').classList.remove('hidden');
                        }
                    }

                } else {
                    // No attendance for today, show clock-in form
                    document.getElementById('clock-in-section').classList.remove('hidden');
                    document.getElementById('clock-out-section').classList.add('hidden');
                    document.getElementById('remark-field').classList.add('hidden');
                    document.getElementById('job-photo-field').classList.add('hidden');
                    document.getElementById('attendance-form').classList.remove('hidden');
                    document.getElementById('absensi-info').classList.add('hidden');
                    document.getElementById('duty-as').value = '';
                    document.getElementById('type-of-work').value = '';
                }
            });
        };

        document.getElementById('clock-in-btn').addEventListener('click', async () => {
            showLoading('Mengambil lokasi dan mengakses kamera...');
            try {
                const coords = await getGeoLocation();
                const imageFile = document.getElementById('photo-in').files[0];
                const duty = document.getElementById('duty-as').value;
                const workType = document.getElementById('type-of-work').value;
                const now = new Date();
                const timeStr = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const dateStr = now.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
                
                if (!imageFile || !duty || !workType) {
                    hideLoading();
                    showErrorModal('Semua kolom absen masuk wajib diisi.');
                    return;
                }

                // Check radius
                const officeCoords1 = { latitude: -6.267716, longitude: 106.897317 };
                const officeCoords2 = { latitude: -6.265146, longitude: 106.885701 };
                const distance1 = haversineDistance(coords, officeCoords1);
                const distance2 = haversineDistance(coords, officeCoords2);
                
                const isWithinRadius = distance1 <= 250 || distance2 <= 250;
                let radiusStatus = 'Diluar radius. Wajib isi alasan.';
                let reasonForOutsideRadius = '';

                if (isWithinRadius) {
                    radiusStatus = 'Anda berada dalam radius kantor.';
                } else {
                    reasonForOutsideRadius = prompt("Anda berada di luar radius kantor. Masukkan alasan:");
                    if (!reasonForOutsideRadius) {
                        hideLoading();
                        showErrorModal('Alasan berada di luar radius wajib diisi.');
                        return;
                    }
                }

                const statusMasuk = now.getHours() < 9 ? 'Terima Kasih Anda Telah Absen Tepat Waktu' : 'Anda Terlambat Absen';
                const alasanTerlambat = statusMasuk === 'Anda Terlambat Absen' ? prompt("Anda terlambat. Masukkan alasan keterlambatan:") : '';

                const base64Image = await toBase64(imageFile);
                const imageRef = ref(storage, `photos/${userId}/in/${new Date().toISOString()}.png`);
                await uploadString(imageRef, base64Image, 'data_url');
                const photoInUrl = await getDownloadURL(imageRef);

                const absenData = {
                    idUser: userId,
                    name: userProfile.name,
                    email: userProfile.email,
                    division: userProfile.division,
                    position: userProfile.position,
                    duty: duty,
                    typeOfWork: workType,
                    statusAbsen: 'on working',
                    dateMasuk: dateStr,
                    absenMasuk: timeStr,
                    statusMasuk: statusMasuk,
                    alasanTerlambat: alasanTerlambat,
                    photoMasuk: photoInUrl,
                    locationMasuk: {
                        latitude: coords.latitude,
                        longitude: coords.longitude
                    },
                    radius: radiusStatus,
                    reasonForOutsideRadius: reasonForOutsideRadius
                };

                await setDoc(todayAbsenceDocRef, absenData);
                hideLoading();
            } catch (e) {
                hideLoading();
                console.error("Error clocking in:", e);
                showErrorModal(`Gagal absen masuk: ${e}`);
            }
        });

        document.getElementById('clock-out-btn').addEventListener('click', async () => {
            showLoading('Mengambil lokasi dan mengunggah foto...');
            try {
                const docSnap = await getDoc(todayAbsenceDocRef);
                if (!docSnap.exists()) {
                    hideLoading();
                    showErrorModal('Belum ada data absen masuk hari ini.');
                    return;
                }
                const absenIn = docSnap.data();

                const coords = await getGeoLocation();
                const jobRemark = document.getElementById('remark-job').value;
                const jobPhotoFile = document.getElementById('photo-job').files[0];

                if (!jobRemark || !jobPhotoFile) {
                     hideLoading();
                     showErrorModal('Semua kolom absen pulang wajib diisi.');
                     return;
                }

                const now = new Date();
                const timeOutStr = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                
                const absenMasukTime = new Date(absenIn.dateMasuk + ' ' + absenIn.absenMasuk);
                const totalWorktimeMs = now - absenMasukTime;
                const hours = Math.floor(totalWorktimeMs / (1000 * 60 * 60));
                const minutes = Math.floor((totalWorktimeMs % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((totalWorktimeMs % (1000 * 60)) / 1000);
                const totalWorktimeStr = `${hours} jam, ${minutes} menit, ${seconds} detik`;

                let statusPulang, totalOvertime = null;
                const pulangHour = now.getHours();
                const pulangMinute = now.getMinutes();

                if (pulangHour < 17) {
                    statusPulang = 'Anda Pulang Sebelum waktunya';
                } else if (pulangHour === 17 && pulangMinute <= 30) {
                    statusPulang = 'Anda Pulang tepat Waktu';
                } else {
                    statusPulang = 'Waktu Kerja Melebihi';
                    const overtimeStart = new Date();
                    overtimeStart.setHours(17, 31, 0, 0);
                    const overtimeMs = now - overtimeStart;
                    const otHours = Math.floor(overtimeMs / (1000 * 60 * 60));
                    const otMinutes = Math.floor((overtimeMs % (1000 * 60 * 60)) / (1000 * 60));
                    const otSeconds = Math.floor((overtimeMs % (1000 * 60)) / 1000);
                    totalOvertime = `${otHours} jam, ${otMinutes} menit, ${otSeconds} detik`;
                }
                
                const officeCoords1 = { latitude: -6.267716, longitude: 106.897317 };
                const officeCoords2 = { latitude: -6.265146, longitude: 106.885701 };
                const distance1 = haversineDistance(coords, officeCoords1);
                const distance2 = haversineDistance(coords, officeCoords2);
                
                const isWithinRadius = distance1 <= 250 || distance2 <= 250;
                let radiusStatus = 'Diluar radius. Wajib isi alasan.';
                let reasonForOutsideRadius = '';

                if (isWithinRadius) {
                    radiusStatus = 'Anda berada dalam radius kantor.';
                } else {
                    reasonForOutsideRadius = prompt("Anda berada di luar radius kantor. Masukkan alasan:");
                    if (!reasonForOutsideRadius) {
                        hideLoading();
                        showErrorModal('Alasan berada di luar radius wajib diisi.');
                        return;
                    }
                }

                const base64Image = await toBase64(jobPhotoFile);
                const imageRef = ref(storage, `photos/${userId}/out/${new Date().toISOString()}.png`);
                await uploadString(imageRef, base64Image, 'data_url');
                const photoOutUrl = await getDownloadURL(imageRef);

                await setDoc(todayAbsenceDocRef, {
                    absenPulang: timeOutStr,
                    statusPulang: statusPulang,
                    totalOvertime: totalOvertime,
                    totalWorktime: totalWorktimeStr,
                    remarkPekerjaan: jobRemark,
                    photoPekerjaan: photoOutUrl,
                    locationPulang: {
                        latitude: coords.latitude,
                        longitude: coords.longitude
                    },
                    radiusPulang: radiusStatus,
                    reasonForOutsideRadiusPulang: reasonForOutsideRadius
                }, { merge: true });

                hideLoading();
            } catch (e) {
                hideLoading();
                console.error("Error clocking out:", e);
                showErrorModal(`Gagal absen pulang: ${e}`);
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            showLoginPage();
            userProfile = null;
        });

        document.getElementById('modal-close-btn').addEventListener('click', hideErrorModal);
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .bg-gradient-custom {
            background-image: linear-gradient(135deg, #0f172a 0%, #1a2a44 100%);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-80 hidden">
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-t-4 border-gray-200 border-t-blue-500 rounded-full animate-spin"></div>
            <p id="loading-message" class="mt-4 text-white text-lg font-semibold">Memuat...</p>
        </div>
    </div>

    <!-- Error/Info Modal -->
    <div id="error-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-80 hidden">
        <div class="bg-white p-6 rounded-xl shadow-lg max-w-sm w-full text-center">
            <h2 class="text-xl font-bold text-red-600 mb-4">Peringatan</h2>
            <p id="error-message" class="text-gray-700"></p>
            <button id="modal-close-btn" class="mt-6 px-6 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-300">Tutup</button>
        </div>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="w-full max-w-md bg-white rounded-xl shadow-lg p-8 transform transition-all duration-300">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Login Karyawan</h1>
            <p class="text-sm text-gray-500">Ecrew Absensi Transwisat Prima Aviation</p>
        </div>
        <form id="login-form">
            <div class="mb-4">
                <label for="email" class="block text-gray-700 font-semibold mb-2">Email Valid</label>
                <input type="email" id="email" name="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan email Anda" required>
            </div>
            <div class="mb-6">
                <label for="password" class="block text-gray-700 font-semibold mb-2">Password</label>
                <input type="password" id="password" name="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan password Anda" required>
            </div>
            <button type="submit" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-300">LOGIN</button>
        </form>
        <p class="mt-4 text-xs text-gray-400 text-center">App ID: <span id="app-id-display" class="font-mono"></span></p>
    </div>

    <!-- Attendance Page -->
    <div id="attendance-page" class="w-full max-w-2xl bg-white rounded-xl shadow-lg p-8 hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Halaman Absensi</h1>
            <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-300">Logout</button>
        </div>
        
        <div class="bg-gray-100 p-6 rounded-xl mb-6">
            <h2 class="text-xl font-bold text-gray-700 mb-4">Informasi Karyawan</h2>
            <p class="text-sm text-gray-600"><span class="font-semibold">Nama:</span> <span id="profile-name"></span></p>
            <p class="text-sm text-gray-600"><span class="font-semibold">Email:</span> <span id="profile-email"></span></p>
            <p class="text-sm text-gray-600"><span class="font-semibold">Divisi:</span> <span id="profile-division"></span></p>
            <p class="text-sm text-gray-600"><span class="font-semibold">Jabatan:</span> <span id="profile-position"></span></p>
            <p class="text-sm text-gray-600"><span class="font-semibold">ID Pengguna:</span> <span id="profile-id" class="break-words"></span></p>
        </div>

        <form id="attendance-form" class="hidden">
            <!-- Clock In Section -->
            <div id="clock-in-section" class="bg-blue-50 p-6 rounded-xl mb-6">
                <h2 class="text-xl font-bold text-blue-800 mb-4">Absen Masuk (Clock In)</h2>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label for="duty-as" class="block text-gray-700 font-semibold mb-2">Duty As</label>
                        <input type="text" id="duty-as" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Pilot On Duty" required>
                    </div>
                    <div>
                        <label for="type-of-work" class="block text-gray-700 font-semibold mb-2">Type of Work</label>
                        <input type="text" id="type-of-work" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: Flight" required>
                    </div>
                </div>
                <div class="mt-4">
                    <label for="photo-in" class="block text-gray-700 font-semibold mb-2">Foto Masuk (dari kamera)</label>
                    <input type="file" id="photo-in" accept="image/*" capture="environment" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <button type="button" id="clock-in-btn" class="mt-6 w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-300">CLOCK IN SEKARANG</button>
            </div>

            <!-- Clock Out Section -->
            <div id="clock-out-section" class="bg-green-50 p-6 rounded-xl hidden">
                <h2 class="text-xl font-bold text-green-800 mb-4">Absen Pulang (Clock Out)</h2>
                <div class="space-y-4">
                    <div id="remark-field">
                        <label for="remark-job" class="block text-gray-700 font-semibold mb-2">Remark Pekerjaan Hari Ini</label>
                        <textarea id="remark-job" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Jelaskan pekerjaan Anda hari ini" required></textarea>
                    </div>
                    <div id="job-photo-field">
                        <label for="photo-job" class="block text-gray-700 font-semibold mb-2">Foto Pekerjaan Hari Ini (dari galeri)</label>
                        <input type="file" id="photo-job" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                    </div>
                </div>
                <div id="clock-out-button-container">
                    <button type="button" id="clock-out-btn" class="mt-6 w-full py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition duration-300">CLOCK OUT SEKARANG</button>
                </div>
            </div>
        </form>

        <!-- Absensi Realtime Info -->
        <div id="absensi-info" class="mt-6 hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Data Absensi Hari Ini</h2>
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-2">
                        <p class="text-xs font-semibold text-gray-500">Nama</p>
                        <p class="font-bold text-gray-800" id="absensi-name"></p>
                    </div>
                    <div class="mb-2">
                        <p class="text-xs font-semibold text-gray-500">Email</p>
                        <p class="font-bold text-gray-800" id="absensi-email"></p>
                    </div>
                    <div class="mb-2">
                        <p class="text-xs font-semibold text-gray-500">Divisi</p>
                        <p class="font-bold text-gray-800" id="absensi-division"></p>
                    </div>
                    <div class="mb-2">
                        <p class="text-xs font-semibold text-gray-500">Jabatan</p>
                        <p class="font-bold text-gray-800" id="absensi-position"></p>
                    </div>
                    <div class="mb-2">
                        <p class="text-xs font-semibold text-gray-500">Duty As</p>
                        <p class="font-bold text-gray-800" id="absensi-duty"></p>
                    </div>
                    <div class="mb-2">
                        <p class="text-xs font-semibold text-gray-500">Type of Work</p>
                        <p class="font-bold text-gray-800" id="absensi-work-type"></p>
                    </div>
                </div>

                <hr class="my-4">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-2">
                        <p class="text-xs font-semibold text-gray-500">Tanggal Masuk</p>
                        <p class="font-bold text-gray-800" id="absensi-date-in"></p>
                    </div>
                    <div class="mb-2">
                        <p class="text-xs font-semibold text-gray-500">Waktu Masuk</p>
                        <p class="font-bold text-gray-800" id="absensi-time-in"></p>
                    </div>
                    <div class="mb-2">
                        <p class="text-xs font-semibold text-gray-500">Status Masuk</p>
                        <p class="font-bold text-green-600" id="absensi-status-in"></p>
                    </div>
                    <div id="late-reason-section" class="mb-2 hidden">
                        <p class="text-xs font-semibold text-gray-500">Alasan Terlambat</p>
                        <p class="font-bold text-gray-800" id="absensi-reason"></p>
                    </div>
                    <div class="mb-2">
                        <p class="text-xs font-semibold text-gray-500">Lokasi Masuk</p>
                        <p class="font-bold text-gray-800" id="absensi-location-in"></p>
                    </div>
                    <div class="mb-2">
                        <p class="text-xs font-semibold text-gray-500">Radius Masuk</p>
                        <p class="font-bold text-gray-800" id="absensi-radius-in"></p>
                    </div>
                </div>

                <hr class="my-4">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-2">
                        <p class="text-xs font-semibold text-gray-500">Waktu Pulang</p>
                        <p class="font-bold text-gray-800" id="absensi-time-out"></p>
                    </div>
                    <div class="mb-2">
                        <p class="text-xs font-semibold text-gray-500">Status Pulang</p>
                        <p class="font-bold text-gray-800" id="absensi-status-out"></p>
                    </div>
                    <div class="mb-2">
                        <p class="text-xs font-semibold text-gray-500">Total Waktu Kerja</p>
                        <p class="font-bold text-gray-800" id="absensi-total-worktime"></p>
                    </div>
                    <div id="total-overtime-row" class="mb-2 hidden">
                        <p class="text-xs font-semibold text-gray-500">Total Lembur</p>
                        <p class="font-bold text-gray-800" id="absensi-total-overtime"></p>
                    </div>
                    <div class="mb-2">
                        <p class="text-xs font-semibold text-gray-500">Lokasi Pulang</p>
                        <p class="font-bold text-gray-800" id="absensi-location-out"></p>
                    </div>
                    <div class="mb-2">
                        <p class="text-xs font-semibold text-gray-500">Radius Pulang</p>
                        <p class="font-bold text-gray-800" id="absensi-radius-out"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
