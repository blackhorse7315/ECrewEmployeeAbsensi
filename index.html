<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECrew Absensi Karyawan Transwisata</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .pulse-animation { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .slide-in { animation: slideIn 0.5s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-marquee { animation: marquee 30s linear infinite; }
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl card-shadow p-8 w-full max-w-md slide-in">
            <div class="text-center mb-8">
                <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" id="loginLogo">
                    <img src="" alt="Logo" class="w-10 h-10 object-contain hidden" id="loginLogoImg">
                    <i class="fas fa-users text-white text-2xl" id="loginLogoIcon"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2" id="loginTitle">ECrew Absensi</h1>
                <p class="text-gray-600" id="loginSubtitle">Transwisata Employee System</p>
            </div>

            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="loginEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="nama@transwisata.com" required>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="••••••••" required>
                </div>

                <div class="flex items-center justify-between">
                    <label class="flex items-center">
                        <input type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-600">Ingat saya</span>
                    </label>
                    <a href="#" class="text-sm text-blue-600 hover:text-blue-800">Lupa password?</a>
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium">
                    Masuk
                </button>
            </form>
            <div id="loginError" class="mt-4 text-center text-red-600 font-medium hidden"></div>
        </div>
    </div>
    <!-- User Dashboard -->
    <div id="userDashboard" class="hidden min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <div class="bg-blue-600 w-8 h-8 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-users text-white text-sm"></i>
                        </div>
                        <h1 class="text-xl font-semibold text-gray-800">ECrew Absensi</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600">Selamat datang, <span id="userName" class="font-medium">John Doe</span></span>
                        <div class="relative">
                            <button onclick="toggleProfileMenu()" class="flex items-center space-x-2 focus:outline-none">
                                <div class="w-8 h-8 rounded-full overflow-hidden border-2 border-gray-300 hover:border-blue-500 transition duration-200">
                                    <img id="userProfilePhoto" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236B7280'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" alt="Profile" class="w-full h-full object-cover">
                                </div>
                                <i class="fas fa-chevron-down text-xs text-gray-500"></i>
                            </button>

                            <!-- Profile Dropdown -->
                            <div id="profileMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                                <div class="py-2">
                                    <button onclick="showProfileModal()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                        <i class="fas fa-user mr-2"></i>Edit Profile
                                    </button>
                                    <button onclick="logout()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center">
                                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- News Ticker -->
        <div class="bg-blue-600 text-white py-2 overflow-hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center">
                    <span class="bg-white text-blue-600 px-3 py-1 rounded-full text-sm font-medium mr-4 flex-shrink-0">
                        <i class="fas fa-bullhorn mr-1"></i>BERITA
                    </span>
                    <div class="overflow-hidden flex-1">
                        <div id="newsTickerContent" class="whitespace-nowrap animate-marquee">
                            <!-- News ticker will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Latest News Section -->
            <div class="bg-white rounded-2xl card-shadow p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-newspaper text-blue-600 mr-2"></i>
                        Berita Terkini
                    </h2>
                    <button onclick="showTab('news')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        Lihat Semua <i class="fas fa-arrow-right ml-1"></i>
                    </button>
                </div>
                <div id="newsPreviewContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- News will be populated by JavaScript -->
                </div>
            </div>

            <!-- Clock In/Out Section -->
            <div class="bg-white rounded-2xl card-shadow p-8 mb-8">
                <div class="text-center mb-6">
                    <div class="mb-6">
                        <div id="currentTime" class="text-4xl font-bold text-gray-800 mb-2"></div>
                        <div id="currentDate" class="text-lg text-gray-600"></div>
                    </div>

                    <div class="flex justify-center space-x-6">
                        <button id="clockInBtn" onclick="showClockInForm()" class="bg-green-500 hover:bg-green-600 text-white px-8 py-4 rounded-xl font-medium transition duration-200 pulse-animation">
                            <i class="fas fa-clock mr-2"></i>Clock In
                        </button>
                        <button id="clockOutBtn" onclick="showClockOutForm()" class="bg-red-500 hover:bg-red-600 text-white px-8 py-4 rounded-xl font-medium transition duration-200 disabled:opacity-50" disabled>
                            <i class="fas fa-clock mr-2"></i>Clock Out
                        </button>
                    </div>
                </div>

                <!-- Clock In Form -->
                <div id="clockInForm" class="hidden mt-8 border-t pt-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6 text-center">Form Absen Masuk</h3>
                    <form id="attendanceInForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Personal Info -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap *</label>
                                <input type="text" id="employeeName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                <input type="email" id="employeeEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Divisi *</label>
                                <input type="text" id="employeeDivision" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Posisi *</label>
                                <input type="text" id="employeePosition" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Bertugas Sebagai *</label>
                                <select id="dutyAs" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">Pilih Tugas</option>
                                    <option value="Director">Director</option>
                                    <option value="Safety, Quality & Security Manager">Safety, Quality & Security Manager</option>
                                    <option value="Operation Manager">Operation Manager</option>
                                    <option value="Maintenance Manager">Maintenance Manager</option>
                                    <option value="Chief Pilot Fixed Wing">Chief Pilot Fixed Wing</option>
                                    <option value="Chief Pilot Rotary Wing">Chief Pilot Rotary Wing</option>
                                    <option value="Chief Flight Support">Chief Flight Support</option>
                                    <option value="Chief Inspector">Chief Inspector</option>
                                    <option value="Chief Engineer">Chief Engineer</option>
                                    <option value="Chief Finance, Accounting & Staf">Chief Finance, Accounting & Staf</option>
                                    <option value="Chief Engineering">Chief Engineering</option>
                                    <option value="Pilot in Command">Pilot in Command</option>
                                    <option value="Second in Command">Second in Command</option>
                                    <option value="Ground Instructor">Ground Instructor</option>
                                    <option value="Flight Instructor">Flight Instructor</option>
                                    <option value="Company Check Pilot">Company Check Pilot</option>
                                    <option value="Engineer">Engineer</option>
                                    <option value="Line Pilot">Line Pilot</option>
                                    <option value="Cabin Service">Cabin Service</option>
                                    <option value="Student">Student</option>
                                    <option value="Flight Support">Flight Support</option>
                                    <option value="Ground Support">Ground Support</option>
                                    <option value="Technical Representative">Technical Representative</option>
                                    <option value="Engineering">Engineering</option>
                                    <option value="Staff">Staff</option>
                                    <option value="Logistic">Logistic</option>
                                    <option value="Aviation Security">Aviation Security</option>
                                    <option value="Driver">Driver</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Pekerjaan *</label>
                                <select id="workType" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                    <option value="">Pilih Jenis Pekerjaan</option>
                                    <option value="Office Hour">Office Hour</option>
                                    <option value="Standby Flight">Standby Flight</option>
                                    <option value="Standby on Call">Standby on Call</option>
                                    <option value="Pos One Gate">Pos One Gate</option>
                                    <option value="Day Off">Day Off</option>
                                    <option value="Day Off 7 Consecutive Days for Pilot">Day Off 7 Consecutive Days for Pilot</option>
                                    <option value="Flight Duty VIP">Flight Duty VIP</option>
                                    <option value="Ferry Flight">Ferry Flight</option>
                                    <option value="PPC Simulator">PPC Simulator</option>
                                    <option value="PPC Aircraft">PPC Aircraft</option>
                                    <option value="Test Flight">Test Flight</option>
                                    <option value="Ground Run">Ground Run</option>
                                    <option value="Recurrent Training">Recurrent Training</option>
                                    <option value="Recency Flight">Recency Flight</option>
                                    <option value="Meeting Out of Office">Meeting Out of Office</option>
                                    <option value="Medical Examination">Medical Examination</option>
                                    <option value="Annual Leave">Annual Leave</option>
                                    <option value="Sick">Sick</option>
                                    <option value="Technical Representative">Technical Representative</option>
                                    <option value="Aviation Security">Aviation Security</option>
                                    <option value="Over Time">Over Time</option>
                                </select>
                            </div>
                        </div>

                        <!-- Photo Section -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Foto Masuk *</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                                <video id="cameraPreview" class="hidden w-full max-w-sm mx-auto rounded-lg mb-4"></video>
                                <canvas id="photoCanvas" class="hidden"></canvas>
                                <img id="capturedPhoto" class="hidden w-full max-w-sm mx-auto rounded-lg mb-4">
                                <div id="cameraControls">
                                    <button type="button" onclick="startCamera()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mr-2">
                                        <i class="fas fa-camera mr-2"></i>Buka Kamera
                                    </button>
                                    <button type="button" id="captureBtn" onclick="capturePhoto()" class="hidden bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 mr-2">
                                        <i class="fas fa-camera mr-2"></i>Ambil Foto
                                    </button>
                                    <button type="button" id="retakeBtn" onclick="retakePhoto()" class="hidden bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700">
                                        <i class="fas fa-redo mr-2"></i>Foto Ulang
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Location Section -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi Masuk *</label>
                            <div class="space-y-4">
                                <button type="button" onclick="getCurrentLocation('in')" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-map-marker-alt mr-2"></i>Dapatkan Lokasi Saat Ini
                                </button>
                                <div id="locationInInfo" class="hidden p-4 bg-gray-50 rounded-lg">
                                    <p class="text-sm text-gray-600 mb-2">Koordinat: <span id="coordsIn" class="font-mono"></span></p>
                                    <p class="text-sm text-gray-600 mb-2">Alamat: <span id="addressIn"></span></p>
                                    <div id="radiusStatusIn" class="p-3 rounded-lg text-sm font-medium"></div>
                                </div>
                                <div id="mapIn" class="hidden h-64 rounded-lg border bg-gray-100 flex items-center justify-center">
                                    <div class="text-center">
                                        <i class="fas fa-map-marker-alt text-4xl text-gray-400 mb-2"></i>
                                        <p class="text-gray-500">Peta lokasi akan ditampilkan di sini</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Reason for Outside Radius -->
                        <div id="outsideReasonIn" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Alasan Berada di Luar Radius Kantor *</label>
                            <textarea id="outsideReasonTextIn" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Jelaskan alasan Anda berada di luar radius kantor..."></textarea>
                        </div>

                        <!-- Late Reason -->
                        <div id="lateReasonSection" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Alasan Terlambat *</label>
                            <textarea id="lateReasonText" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Jelaskan alasan keterlambatan Anda..."></textarea>
                        </div>
                        <div class="flex justify-center space-x-4">
                            <button type="button" onclick="hideClockInForm()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                Batal
                            </button>
                            <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                <i class="fas fa-check mr-2"></i>Submit Absen Masuk
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Clock Out Form -->
                <div id="clockOutForm" class="hidden mt-8 border-t pt-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6 text-center">Form Absen Pulang</h3>
                    <form id="attendanceOutForm" class="space-y-6">
                        <!-- Location Section -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi Pulang *</label>
                            <div class="space-y-4">
                                <button type="button" onclick="getCurrentLocation('out')" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-map-marker-alt mr-2"></i>Dapatkan Lokasi Saat Ini
                                </button>
                                <div id="locationOutInfo" class="hidden p-4 bg-gray-50 rounded-lg">
                                    <p class="text-sm text-gray-600 mb-2">Koordinat: <span id="coordsOut" class="font-mono"></span></p>
                                    <p class="text-sm text-gray-600 mb-2">Alamat: <span id="addressOut"></span></p>
                                    <div id="radiusStatusOut" class="p-3 rounded-lg text-sm font-medium"></div>
                                </div>
                                <div id="mapOut" class="hidden h-64 rounded-lg border bg-gray-100 flex items-center justify-center">
                                    <div class="text-center">
                                        <i class="fas fa-map-marker-alt text-4xl text-gray-400 mb-2"></i>
                                        <p class="text-gray-500">Peta lokasi akan ditampilkan di sini</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Reason for Outside Radius -->
                        <div id="outsideReasonOut" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Alasan Berada di Luar Radius Kantor *</label>
                            <textarea id="outsideReasonTextOut" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Jelaskan alasan Anda berada di luar radius kantor..."></textarea>
                        </div>

                        <!-- Work Report -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Laporan Pekerjaan Hari Ini *</label>
                            <textarea id="workReport" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" rows="4" placeholder="Jelaskan pekerjaan yang telah Anda selesaikan hari ini..." required></textarea>
                        </div>

                        <!-- Work Photo -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Foto Pekerjaan Hari Ini</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                                <input type="file" id="workPhotoInput" accept="image/*" class="hidden" onchange="previewWorkPhoto(event)">
                                <img id="workPhotoPreview" class="hidden w-full max-w-sm mx-auto rounded-lg mb-4">
                                <div id="workPhotoControls">
                                    <button type="button" onclick="document.getElementById('workPhotoInput').click()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                        <i class="fas fa-image mr-2"></i>Pilih Foto dari Gallery
                                    </button>
                                    <p class="text-sm text-gray-500 mt-2">Format: JPG, PNG (Max 5MB)</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-center space-x-4">
                            <button type="button" onclick="hideClockOutForm()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                Batal
                            </button>
                            <button type="submit" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                <i class="fas fa-check mr-2"></i>Submit Absen Pulang
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Attendance Summary -->
                <div id="attendanceSummary" class="hidden mt-8 border-t pt-8">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6 text-center">Ringkasan Absensi Hari Ini</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <p class="text-sm text-gray-600">Status Absen</p>
                                <p id="attendanceStatusText" class="font-medium text-lg"></p>
                            </div>
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <p class="text-sm text-gray-600">Absen Masuk</p>
                                <p id="clockInTime" class="font-medium"></p>
                            </div>
                            <div class="p-4 bg-gray-50 rounded-lg">
                                <p class="text-sm text-gray-600">Status Masuk</p>
                                <p id="clockInStatus" class="font-medium"></p>
                            </div>
                            <div id="clockOutTimeDiv" class="hidden p-4 bg-gray-50 rounded-lg">
                                <p class="text-sm text-gray-600">Absen Pulang</p>
                                <p id="clockOutTime" class="font-medium"></p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div id="clockOutStatusDiv" class="hidden p-4 bg-gray-50 rounded-lg">
                                <p class="text-sm text-gray-600">Status Pulang</p>
                                <p id="clockOutStatus" class="font-medium"></p>
                            </div>
                            <div id="overtimeDiv" class="hidden p-4 bg-gray-50 rounded-lg">
                                <p class="text-sm text-gray-600">Total Overtime</p>
                                <p id="overtimeHours" class="font-medium"></p>
                            </div>
                            <div id="worktimeDiv" class="hidden p-4 bg-gray-50 rounded-lg">
                                <p class="text-sm text-gray-600">Total Waktu Kerja</p>
                                <p id="totalWorktime" class="font-medium"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center">
                        <div class="bg-blue-100 p-3 rounded-lg">
                            <i class="fas fa-calendar-check text-blue-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Hadir Bulan Ini</p>
                            <p id="monthlyAttendance" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center">
                        <div class="bg-green-100 p-3 rounded-lg">
                            <i class="fas fa-clock text-green-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Jam Kerja</p>
                            <p id="monthlyWorkHours" class="text-2xl font-bold text-gray-800">0h</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center">
                        <div class="bg-yellow-100 p-3 rounded-lg">
                            <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Terlambat</p>
                            <p id="monthlyLate" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Tabs -->
            <div class="bg-white rounded-2xl card-shadow">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6">
                        <button onclick="showTab('history')" class="tab-btn py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-medium" data-tab="history">
                            Riwayat Absen
                        </button>
                    </nav>
                </div>

                <!-- History Tab -->
                <div id="historyTab" class="p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Riwayat Absensi</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Tanggal</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Clock In</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Clock Out</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Status</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceHistory">
                                <tr id="noDataRow">
                                    <td colspan="4" class="py-8 px-4 text-center text-gray-500">
                                        <i class="fas fa-calendar-times text-4xl mb-2"></i>
                                        <p>Belum ada data absensi</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>
    <!-- News Detail Modal -->
    <div id="newsDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl card-shadow w-full max-w-4xl mx-4 slide-in max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 id="newsDetailTitle" class="text-2xl font-bold text-gray-800">Detail Berita</h2>
                    <button onclick="hideNewsDetail()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <div id="newsDetailContent" class="space-y-6">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    <!-- Attendance Detail Modal -->
    <div id="attendanceDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl card-shadow w-full max-w-4xl mx-4 slide-in max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">Detail Absensi</h2>
                    <button onclick="hideAttendanceDetail()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <div id="attendanceDetailContent" class="space-y-6">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    <!-- News Management Modal -->
    <div id="newsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl card-shadow w-full max-w-2xl mx-4 slide-in max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 id="newsModalTitle" class="text-2xl font-bold text-gray-800">Tambah Berita</h2>
                    <button onclick="hideNewsModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <form id="newsForm" class="space-y-6">
                    <input type="hidden" id="newsId">

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Judul Berita *</label>
                        <input type="text" id="newsTitle" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kategori *</label>
                        <select id="newsCategory" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                            <option value="">Pilih Kategori</option>
                            <option value="HR">HR</option>
                            <option value="Training">Training</option>
                            <option value="Announcement">Pengumuman</option>
                            <option value="Event">Event</option>
                            <option value="Policy">Kebijakan</option>
                            <option value="Safety">Keselamatan</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ringkasan *</label>
                        <textarea id="newsSummary" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" rows="3" placeholder="Ringkasan singkat berita..." required></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Konten Lengkap *</label>
                        <textarea id="newsContent" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" rows="8" placeholder="Tulis konten berita lengkap di sini..." required></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Foto Berita</label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="newsImageInput" accept="image/*" class="hidden" onchange="previewNewsImage(event)">
                            <img id="newsImagePreview" class="hidden w-full max-w-sm mx-auto rounded-lg mb-4">
                            <div id="newsImageControls">
                                <button type="button" onclick="document.getElementById('newsImageInput').click()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 mb-2">
                                    <i class="fas fa-image mr-2"></i>Pilih Foto
                                </button>
                                <p class="text-sm text-gray-500 mt-2">Format: JPG, PNG (Max 5MB)</p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Penulis</label>
                        <input type="text" id="newsAuthor" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Nama penulis atau departemen">
                    </div>

                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="newsActive" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500" checked>
                            <span class="ml-2 text-sm text-gray-700">Aktifkan berita</span>
                        </label>

                        <label class="flex items-center">
                            <input type="checkbox" id="newsNotify" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                            <span class="ml-2 text-sm text-gray-700">Kirim notifikasi</span>
                        </label>
                    </div>

                    <div class="flex justify-center space-x-4 pt-4">
                        <button type="button" onclick="hideNewsModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200">
                            Batal
                        </button>
                        <button type="submit" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-200">
                            <i class="fas fa-save mr-2"></i>Simpan Berita
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Admin Attendance Edit Modal -->
    <div id="adminAttendanceEditModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl card-shadow w-full max-w-6xl mx-4 slide-in max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">Edit Data Absensi</h2>
                    <button onclick="hideAdminAttendanceEdit()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <form id="adminAttendanceEditForm" class="space-y-8">
                    <input type="hidden" id="editAttendanceId">

                    <!-- Employee Info (Read-only) -->
                    <div class="bg-gray-50 rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Informasi Karyawan</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" id="editEmployeeName" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" id="editEmployeeEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Divisi</label>
                                <input type="text" id="editEmployeeDivision" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Posisi</label>
                                <input type="text" id="editEmployeePosition" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Clock In Section -->
                    <div class="bg-green-50 border border-green-200 rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-green-800 mb-4">Data Clock In</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal & Waktu Clock In</label>
                                    <input type="datetime-local" id="editClockInTime" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Bertugas Sebagai</label>
                                    <select id="editDutyAs" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                        <option value="Director">Director</option>
                                        <option value="Safety, Quality & Security Manager">Safety, Quality & Security Manager</option>
                                        <option value="Operation Manager">Operation Manager</option>
                                        <option value="Maintenance Manager">Maintenance Manager</option>
                                        <option value="Chief Pilot Fixed Wing">Chief Pilot Fixed Wing</option>
                                        <option value="Chief Pilot Rotary Wing">Chief Pilot Rotary Wing</option>
                                        <option value="Chief Flight Support">Chief Flight Support</option>
                                        <option value="Chief Inspector">Chief Inspector</option>
                                        <option value="Chief Engineer">Chief Engineer</option>
                                        <option value="Chief Finance, Accounting & Staf">Chief Finance, Accounting & Staf</option>
                                        <option value="Chief Engineering">Chief Engineering</option>
                                        <option value="Pilot in Command">Pilot in Command</option>
                                        <option value="Second in Command">Second in Command</option>
                                        <option value="Ground Instructor">Ground Instructor</option>
                                        <option value="Flight Instructor">Flight Instructor</option>
                                        <option value="Company Check Pilot">Company Check Pilot</option>
                                        <option value="Engineer">Engineer</option>
                                        <option value="Line Pilot">Line Pilot</option>
                                        <option value="Cabin Service">Cabin Service</option>
                                        <option value="Student">Student</option>
                                        <option value="Flight Support">Flight Support</option>
                                        <option value="Ground Support">Ground Support</option>
                                        <option value="Technical Representative">Technical Representative</option>
                                        <option value="Engineering">Engineering</option>
                                        <option value="Staff">Staff</option>
                                        <option value="Logistic">Logistic</option>
                                        <option value="Aviation Security">Aviation Security</option>
                                        <option value="Driver">Driver</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Pekerjaan</label>
                                    <select id="editWorkType" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                        <option value="Office Hour">Office Hour</option>
                                        <option value="Standby Flight">Standby Flight</option>
                                        <option value="Standby on Call">Standby on Call</option>
                                        <option value="Pos One Gate">Pos One Gate</option>
                                        <option value="Day Off">Day Off</option>
                                        <option value="Day Off 7 Consecutive Days for Pilot">Day Off 7 Consecutive Days for Pilot</option>
                                        <option value="Flight Duty VIP">Flight Duty VIP</option>
                                        <option value="Ferry Flight">Ferry Flight</option>
                                        <option value="PPC Simulator">PPC Simulator</option>
                                        <option value="PPC Aircraft">PPC Aircraft</option>
                                        <option value="Test Flight">Test Flight</option>
                                        <option value="Ground Run">Ground Run</option>
                                        <option value="Recurrent Training">Recurrent Training</option>
                                        <option value="Recency Flight">Recency Flight</option>
                                        <option value="Meeting Out of Office">Meeting Out of Office</option>
                                        <option value="Medical Examination">Medical Examination</option>
                                        <option value="Annual Leave">Annual Leave</option>
                                        <option value="Sick">Sick</option>
                                        <option value="Technical Representative">Technical Representative</option>
                                        <option value="Aviation Security">Aviation Security</option>
                                        <option value="Over Time">Over Time</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi Clock In</label>
                                    <input type="text" id="editLocationIn" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 font-mono text-sm" placeholder="lat, lng">
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status Radius Clock In</label>
                                    <select id="editRadiusStatusIn" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                        <option value="true">Dalam Radius</option>
                                        <option value="false">Di Luar Radius</option>
                                    </select>
                                </div>
                                <div id="editOutsideReasonInDiv">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Alasan di Luar Radius</label>
                                    <textarea id="editOutsideReasonIn" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" rows="3"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status Keterlambatan</label>
                                    <select id="editLateStatus" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                        <option value="false">Tepat Waktu</option>
                                        <option value="true">Terlambat</option>
                                    </select>
                                </div>
                                <div id="editLateReasonDiv">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Alasan Terlambat</label>
                                    <textarea id="editLateReason" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" rows="3"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Foto Clock In</label>
                                    <div class="border border-gray-300 rounded-lg p-3">
                                        <img id="editPhotoIn" class="w-full max-w-xs rounded-lg" alt="Foto Clock In">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Clock Out Section -->
                    <div id="editClockOutSection" class="bg-red-50 border border-red-200 rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-red-800 mb-4">Data Clock Out</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal & Waktu Clock Out</label>
                                    <input type="datetime-local" id="editClockOutTime" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi Clock Out</label>
                                    <input type="text" id="editLocationOut" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 font-mono text-sm" placeholder="lat, lng">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Status Radius Clock Out</label>
                                    <select id="editRadiusStatusOut" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                        <option value="true">Dalam Radius</option>
                                        <option value="false">Di Luar Radius</option>
                                    </select>
                                </div>
                                <div id="editOutsideReasonOutDiv">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Alasan di Luar Radius</label>
                                    <textarea id="editOutsideReasonOut" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Laporan Pekerjaan</label>
                                    <textarea id="editWorkReport" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" rows="4"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Foto Pekerjaan</label>
                                    <div class="border border-gray-300 rounded-lg p-3">
                                        <img id="editPhotoOut" class="w-full max-w-xs rounded-lg hidden" alt="Foto Pekerjaan">
                                        <p id="editNoPhotoOut" class="text-gray-500 text-sm">Tidak ada foto pekerjaan</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Notes -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-yellow-800 mb-4">Catatan Admin</h3>
                        <textarea id="editAdminNotes" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500" rows="3" placeholder="Tambahkan catatan admin untuk perubahan ini..."></textarea>
                    </div>

                    <div class="flex justify-center space-x-4 pt-4">
                        <button type="button" onclick="hideAdminAttendanceEdit()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200">
                            Batal
                        </button>
                        <button type="submit" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-200">
                            <i class="fas fa-save mr-2"></i>Simpan Perubahan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Profile Modal -->
    <div id="profileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl card-shadow p-8 w-full max-w-md mx-4 slide-in">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Edit Profile</h2>
                <p class="text-gray-600">Update your profile information</p>
            </div>

            <form id="profileForm" class="space-y-6">
                <!-- Profile Photo Section -->
                <div class="text-center">
                    <div class="relative inline-block">
                        <div class="w-24 h-24 rounded-full overflow-hidden border-4 border-gray-300 mx-auto mb-4">
                            <img id="profilePhotoPreview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236B7280'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E" alt="Profile" class="w-full h-full object-cover">
                        </div>
                        <button type="button" onclick="document.getElementById('profilePhotoInput').click()" class="absolute bottom-0 right-0 bg-blue-600 text-white p-2 rounded-full hover:bg-blue-700 transition duration-200">
                            <i class="fas fa-camera text-sm"></i>
                        </button>
                    </div>
                    <input type="file" id="profilePhotoInput" accept="image/*" class="hidden" onchange="previewProfilePhoto(event)">
                    <p class="text-sm text-gray-500">Click camera icon to change photo</p>
                </div>

                <!-- Profile Info -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                    <input type="text" id="profileName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" value="John Doe">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="profileEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" value="user@transwisata.com" readonly>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nomor Telepon</label>
                    <input type="tel" id="profilePhone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="08xxxxxxxxxx">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Departemen</label>
                    <select id="profileDepartment" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Pilih Departemen</option>
                        <option value="IT">IT</option>
                        <option value="HR">HR</option>
                        <option value="Finance">Finance</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Operations">Operations</option>
                    </select>
                </div>

                <div class="flex justify-center space-x-4 pt-4">
                    <button type="button" onclick="hideProfileModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200">
                        Batal
                    </button>
                    <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
                        <i class="fas fa-save mr-2"></i>Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="hidden min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <div class="bg-purple-600 w-8 h-8 rounded-lg flex items-center justify-center mr-3">
                            <i class="fas fa-cog text-white text-sm"></i>
                        </div>
                        <h1 class="text-xl font-semibold text-gray-800">Admin Panel - ECrew</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600">Admin: <span class="font-medium">Administrator</span></span>
                        <button onclick="logout()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Admin Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Admin Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center">
                        <div class="bg-blue-100 p-3 rounded-lg">
                            <i class="fas fa-users text-blue-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Total Karyawan</p>
                            <p id="totalEmployees" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center">
                        <div class="bg-green-100 p-3 rounded-lg">
                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Hadir Hari Ini</p>
                            <p id="presentToday" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center">
                        <div class="bg-yellow-100 p-3 rounded-lg">
                            <i class="fas fa-clock text-yellow-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Terlambat</p>
                            <p id="lateToday" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center">
                        <div class="bg-red-100 p-3 rounded-lg">
                            <i class="fas fa-times-circle text-red-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Tidak Hadir</p>
                            <p id="absentToday" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Tabs -->
            <div class="bg-white rounded-2xl card-shadow">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6">
                        <button onclick="showAdminTab('news')" class="admin-tab-btn py-4 px-2 border-b-2 border-purple-500 text-purple-600 font-medium" data-tab="news">
                            Kelola Berita
                        </button>
                        <button onclick="showAdminTab('employees')" class="admin-tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="employees">
                            Data Karyawan
                        </button>
                        <button onclick="showAdminTab('attendance')" class="admin-tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="attendance">
                            Riwayat Absen
                        </button>
                        <button onclick="showAdminTab('branding')" class="admin-tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="branding">
                            Logo & Branding
                        </button>
                        <button onclick="showAdminTab('reports')" class="admin-tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="reports">
                            Laporan Absensi
                        </button>
                        <button onclick="showAdminTab('settings')" class="admin-tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="settings">
                            Pengaturan
                        </button>
                    </nav>
                </div>

                <!-- News Management Tab -->
                <div id="newsTab" class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">Kelola Berita</h3>
                        <button onclick="showAddNewsModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-200">
                            <i class="fas fa-plus mr-2"></i>Tambah Berita
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Judul</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Kategori</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Tanggal</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Status</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Notifikasi</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="newsTableBody">
                                <!-- News will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Attendance History Tab -->
                <div id="attendanceTab" class="p-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">Riwayat Absen Karyawan</h3>
                        <div class="flex items-center space-x-4">
                            <!-- Filter Controls -->
                            <div class="flex items-center space-x-2">
                                <input type="text" id="attendanceNameFilter" placeholder="Cari nama karyawan..." class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm">

                                <select id="attendancePeriodFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm">
                                    <option value="daily">Harian</option>
                                    <option value="weekly">Mingguan</option>
                                    <option value="monthly">Bulanan</option>
                                </select>

                                <input type="date" id="attendanceDateFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm">

                                <button onclick="applyAttendanceFilter()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-200 text-sm">
                                    <i class="fas fa-filter mr-1"></i>Apply
                                </button>

                                <button onclick="resetAttendanceFilter()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-200 text-sm">
                                    <i class="fas fa-undo mr-1"></i>Reset
                                </button>

                                <button onclick="downloadAttendancePDF()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 text-sm">
                                    <i class="fas fa-download mr-1"></i>Download PDF
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Filter Summary -->
                    <div id="attendanceFilterSummary" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-blue-800" id="filterSummaryText"></span>
                            <span class="text-sm font-medium text-blue-900" id="filterResultCount"></span>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Nama</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Tanggal</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Clock In</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Clock Out</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Status</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Lokasi</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="attendanceHistoryTableBody">
                                <tr id="noAttendanceDataRow">
                                    <td colspan="7" class="py-8 px-4 text-center text-gray-500">
                                        <i class="fas fa-calendar-times text-4xl mb-2"></i>
                                        <p>Belum ada data absensi</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Employees Tab -->
                <div id="employeesTab" class="p-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-800">Data Karyawan</h3>
                        <div class="flex space-x-2">
                            <input type="text" id="employeeSearch" placeholder="Cari karyawan..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <button onclick="searchEmployees()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition duration-200">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Nama</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Email</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Divisi</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Posisi</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-600">Status</th>
                                </tr>
                            </thead>
                            <tbody id="employeeTableBody">
                                <!-- Employee data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Branding Tab -->
                <div id="brandingTab" class="p-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-6">Logo & Branding</h3>

                    <div class="space-y-8">
                        <!-- Logo Upload Section -->
                        <div class="bg-gray-50 rounded-xl p-6">
                            <h4 class="text-md font-semibold text-gray-800 mb-4">Logo Aplikasi</h4>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Current Logo Preview -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Logo Saat Ini</label>
                                    <div class="bg-white border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                                        <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" id="currentLogoPreview">
                                            <img src="" alt="Current Logo" class="w-10 h-10 object-contain hidden" id="currentLogoImg">
                                            <i class="fas fa-users text-white text-2xl" id="currentLogoIcon"></i>
                                        </div>
                                        <p class="text-sm text-gray-600">Preview logo saat ini</p>
                                    </div>
                                </div>

                                <!-- Logo Upload -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload Logo Baru</label>
                                    <div class="bg-white border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                                        <input type="file" id="logoUpload" accept="image/*" class="hidden" onchange="previewLogo(event)">
                                        <img id="logoPreview" class="hidden w-16 h-16 object-contain mx-auto mb-4 rounded">
                                        <div id="logoUploadControls">
                                            <button type="button" onclick="document.getElementById('logoUpload').click()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 mb-2">
                                                <i class="fas fa-upload mr-2"></i>Pilih Logo
                                            </button>
                                            <p class="text-sm text-gray-500 mt-2">Format: PNG, JPG, SVG (Max 2MB)</p>
                                            <p class="text-xs text-gray-400 mt-1">Rekomendasi: 64x64px atau rasio 1:1</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- App Title Section -->
                        <div class="bg-gray-50 rounded-xl p-6">
                            <h4 class="text-md font-semibold text-gray-800 mb-4">Judul Aplikasi</h4>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Judul Utama</label>
                                    <input type="text" id="appTitle" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="ECrew Absensi">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Subtitle</label>
                                    <input type="text" id="appSubtitle" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Transwisata Employee System">
                                </div>
                            </div>
                        </div>

                        <!-- Preview Section -->
                        <div class="bg-gray-50 rounded-xl p-6">
                            <h4 class="text-md font-semibold text-gray-800 mb-4">Preview Halaman Login</h4>

                            <div class="bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg p-8 flex items-center justify-center">
                                <div class="bg-white rounded-xl p-6 w-full max-w-sm">
                                    <div class="text-center mb-6">
                                        <div class="bg-blue-600 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3" id="previewLogo">
                                            <img src="" alt="Preview Logo" class="w-8 h-8 object-contain hidden" id="previewLogoImg">
                                            <i class="fas fa-users text-white text-lg" id="previewLogoIcon"></i>
                                        </div>
                                        <h1 class="text-lg font-bold text-gray-800 mb-1" id="previewTitle">ECrew Absensi</h1>
                                        <p class="text-sm text-gray-600" id="previewSubtitle">Transwisata Employee System</p>
                                    </div>
                                    <div class="space-y-3">
                                        <div class="h-8 bg-gray-100 rounded"></div>
                                        <div class="h-8 bg-gray-100 rounded"></div>
                                        <div class="h-8 bg-blue-600 rounded"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-center space-x-4">
                            <button onclick="resetBranding()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-200">
                                <i class="fas fa-undo mr-2"></i>Reset ke Default
                            </button>
                            <button onclick="saveBranding()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-200">
                                <i class="fas fa-save mr-2"></i>Simpan Perubahan
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="reportsTab" class="p-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Laporan Absensi</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-medium text-gray-800 mb-2">Laporan Harian</h4>
                            <p class="text-sm text-gray-600 mb-4">Lihat absensi karyawan hari ini</p>
                            <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200" onclick="downloadAttendancePDF('daily')">
                                <i class="fas fa-download mr-2"></i>Download
                            </button>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-medium text-gray-800 mb-2">Laporan Bulanan</h4>
                            <p class="text-sm text-gray-600 mb-4">Rekap absensi bulan ini</p>
                            <button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200" onclick="downloadAttendancePDF('monthly')">
                                <i class="fas fa-download mr-2"></i>Download
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settingsTab" class="p-6 hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Pengaturan Sistem</h3>
                    <div class="space-y-6">
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-medium text-gray-800 mb-2">Jam Kerja</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Jam Masuk</label>
                                    <input type="time" id="workHourStart" value="08:00" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Jam Pulang</label>
                                    <input type="time" id="workHourEnd" value="17:00" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                        </div>
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-medium text-gray-800 mb-2">Toleransi Keterlambatan</h4>
                            <input type="number" id="lateTolerance" value="15" class="w-32 px-3 py-2 border border-gray-300 rounded-lg">
                            <span class="text-sm text-gray-600 ml-2">menit</span>
                        </div>
                        <button onclick="saveSettings()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition duration-200">
                            Simpan Pengaturan
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Custom Modal UI -->
    <div id="customModal" class="modal">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4 card-shadow slide-in">
            <div class="text-center mb-4">
                <i id="modalIcon" class="text-4xl text-blue-500 mb-2"></i>
                <h3 id="modalTitle" class="text-lg font-bold text-gray-800"></h3>
                <p id="modalMessage" class="text-sm text-gray-600 mt-2"></p>
            </div>
            <div class="flex justify-center space-x-4 mt-6">
                <button id="modalConfirmBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 hidden">Ya</button>
                <button id="modalCancelBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">Tutup</button>
            </div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw5dAW1_fGmZy61GNPWLZk5oGtJj2uaAay_B4A1aIQ4544Rv8fM_8EyDUYqc9mQp-cWPw/exec';

        let currentUser = null;
        let isAdmin = false;
        let attendanceData = [];
        let newsData = [];
        let allEmployees = [];
        let appSettings = {};
        let systemSettings = {};
        let clockInDocId = null;

        // Office coordinates for radius check
        const officeLocations = [
            { lat: -6.267716, lng: 106.897317 },
            { lat: -6.265146, lng: 106.885701 }
        ];
        const radiusMeters = 250;

        // Utility function for custom modal
        function showModal(title, message, isConfirm = false, onConfirm = null) {
            const modal = document.getElementById('customModal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;

            const confirmBtn = document.getElementById('modalConfirmBtn');
            const cancelBtn = document.getElementById('modalCancelBtn');

            if (isConfirm) {
                confirmBtn.classList.remove('hidden');
                confirmBtn.onclick = () => {
                    if (onConfirm) onConfirm();
                    modal.style.display = 'none';
                };
            } else {
                confirmBtn.classList.add('hidden');
            }

            cancelBtn.onclick = () => {
                modal.style.display = 'none';
            };

            modal.style.display = 'flex';
        }

        // --- Fetch Data from Google Apps Script ---
        async function fetchDataFromSheet(sheetName) {
            try {
                const response = await fetch(`${WEB_APP_URL}?sheet=${sheetName}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error("Error fetching data:", error);
                showModal('Error', `Gagal mengambil data dari Google Sheet (${sheetName}).`);
                return [];
            }
        }

        // --- Data Submission to Google Apps Script ---
        async function postDataToSheet(sheetName, action, payload) {
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sheet: sheetName, action: action, data: payload })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const result = await response.json();
                return result;
            } catch (error) {
                console.error("Error posting data:", error);
                showModal('Error', `Gagal menyimpan data ke Google Sheet (${sheetName}).`);
                return { success: false, error: error.message };
            }
        }

        // --- Main App Logic ---
        async function loadInitialData() {
            newsData = await fetchDataFromSheet('news');
            const brandingArray = await fetchDataFromSheet('branding');
            appSettings = brandingArray.length > 0 ? brandingArray[0] : {};
            const settingsArray = await fetchDataFromSheet('settings');
            systemSettings = settingsArray.length > 0 ? settingsArray[0] : {};
            allEmployees = await fetchDataFromSheet('employees');

            if (currentUser) {
                const userAttendance = attendanceData.filter(rec => rec.employeeEmail === currentUser.email);
                const today = new Date().toISOString().split('T')[0];
                const todayRecord = userAttendance.find(rec => rec.date === today);
                
                if (todayRecord) {
                    clockInDocId = todayRecord.id;
                }
            }
        }

        function refreshData() {
            loadInitialData().then(() => {
                updateTime();
                updateNewsTicker();
                if (isAdmin) {
                    updateAdminStats();
                    loadNewsTable();
                    loadEmployeeTable();
                    loadAttendanceHistory();
                } else {
                    updateStats();
                    renderAttendanceHistory();
                }
            });
        }
        
        // Polling untuk refresh data
        setInterval(refreshData, 30000); // Refresh setiap 30 detik

        // --- Login & Authentication ---
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const response = await postDataToSheet('login', 'login', { email, password });
            
            if (response.success) {
                currentUser = response.user;
                if (currentUser.role === 'admin') {
                    isAdmin = true;
                    showDashboard('admin');
                } else {
                    isAdmin = false;
                    showDashboard('user');
                }
                refreshData();
            } else {
                document.getElementById('loginError').textContent = response.message || "Email atau password salah.";
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        async function logout() {
            currentUser = null;
            isAdmin = false;
            attendanceData = [];
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('userDashboard').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');
            document.getElementById('loginForm').reset();
            window.location.reload();
        }

        // --- User Dashboard Logic ---
        async function submitClockIn(e) {
            e.preventDefault();
            if (!currentUser) return;
            const now = new Date();

            if (!document.getElementById('capturedPhoto').src) {
                showModal('Peringatan', 'Foto masuk wajib diambil!');
                return;
            }
            if (!document.getElementById('coordsIn').textContent) {
                showModal('Peringatan', 'Lokasi masuk wajib diisi!');
                return;
            }

            const locationIn = JSON.parse(document.getElementById('coordsIn').textContent);
            const withinRadius = isWithinOfficeRadius(locationIn.lat, locationIn.lng);
            if (!withinRadius) {
                const reason = document.getElementById('outsideReasonTextIn').value.trim();
                if (!reason) {
                    showModal('Peringatan', 'Alasan berada di luar radius kantor wajib diisi!');
                    return;
                }
            }

            const isLate = checkIsLate(now);
            if (isLate) {
                const lateReason = document.getElementById('lateReasonText').value.trim();
                if (!lateReason) {
                    document.getElementById('lateReasonSection').classList.remove('hidden');
                    showModal('Peringatan', 'Alasan terlambat wajib diisi!');
                    return;
                }
            }
            
            const newRecord = {
                id: Date.now(), // Use timestamp as unique ID
                date: now.toISOString().split('T')[0],
                employeeName: currentUser.name,
                employeeEmail: currentUser.email,
                employeeDivision: currentUser.division,
                employeePosition: currentUser.position,
                clockIn: JSON.stringify({
                    time: now.toISOString(),
                    dutyAs: document.getElementById('dutyAs').value,
                    workType: document.getElementById('workType').value,
                    location: locationIn,
                    photo: document.getElementById('capturedPhoto').src,
                    withinRadius: withinRadius,
                    outsideReason: withinRadius ? null : document.getElementById('outsideReasonTextIn').value,
                    isLate: isLate,
                    lateReason: isLate ? document.getElementById('lateReasonText').value : null
                }),
                clockOut: null,
                adminNotes: null,
                lastModified: new Date().toISOString(),
                modifiedBy: null
            };

            const result = await postDataToSheet('attendance', 'add', newRecord);
            if (result.success) {
                hideClockInForm();
                showModal('Berhasil!', 'Absen masuk berhasil!');
                refreshData();
            }
        }

        async function submitClockOut(e) {
            e.preventDefault();
            if (!currentUser || !clockInDocId) return;
            const now = new Date();

            const workReport = document.getElementById('workReport').value.trim();
            if (!workReport) {
                showModal('Peringatan', 'Laporan pekerjaan hari ini wajib diisi!');
                return;
            }

            const locationOut = JSON.parse(document.getElementById('coordsOut').textContent);
            const withinRadius = isWithinOfficeRadius(locationOut.lat, locationOut.lng);
            if (!withinRadius) {
                const reason = document.getElementById('outsideReasonTextOut').value.trim();
                if (!reason) {
                    showModal('Peringatan', 'Alasan berada di luar radius kantor wajib diisi!');
                    return;
                }
            }

            const existingRecord = attendanceData.find(rec => rec.id == clockInDocId);
            if (!existingRecord) {
                showModal('Error', 'Catatan absensi tidak ditemukan.');
                return;
            }
            
            const updatedRecord = {
                id: existingRecord.id,
                employeeName: existingRecord.employeeName,
                employeeEmail: existingRecord.employeeEmail,
                employeeDivision: existingRecord.employeeDivision,
                employeePosition: existingRecord.employeePosition,
                date: existingRecord.date,
                clockIn: existingRecord.clockIn,
                clockOut: JSON.stringify({
                    time: now.toISOString(),
                    location: locationOut,
                    withinRadius: withinRadius,
                    outsideReason: withinRadius ? null : document.getElementById('outsideReasonTextOut').value,
                    workReport: workReport,
                    workPhoto: document.getElementById('workPhotoPreview').src || null
                }),
                adminNotes: existingRecord.adminNotes,
                lastModified: new Date().toISOString(),
                modifiedBy: currentUser.email
            };

            const result = await postDataToSheet('attendance', 'save', updatedRecord);
            if (result.success) {
                hideClockOutForm();
                showModal('Berhasil!', 'Absen pulang berhasil!');
                refreshData();
            }
        }

        // --- Admin Dashboard Logic ---
        async function saveNews(e) {
            e.preventDefault();
            const newsId = document.getElementById('newsId').value;
            const newsPayload = {
                id: newsId || Date.now(),
                title: document.getElementById('newsTitle').value,
                category: document.getElementById('newsCategory').value,
                summary: document.getElementById('newsSummary').value,
                content: document.getElementById('newsContent').value,
                author: document.getElementById('newsAuthor').value || 'Admin',
                isActive: document.getElementById('newsActive').checked,
                isNotified: document.getElementById('newsNotify').checked,
                image: document.getElementById('newsImagePreview').src || null,
                date: newsId ? newsData.find(n => n.id == newsId)?.date : new Date().toISOString().split('T')[0]
            };

            let result;
            if (newsId) {
                result = await postDataToSheet('news', 'save', newsPayload);
            } else {
                result = await postDataToSheet('news', 'add', newsPayload);
            }

            if (result.success) {
                showModal('Berhasil!', newsId ? 'Berita berhasil diupdate!' : 'Berita berhasil ditambahkan!');
                hideNewsModal();
                refreshData();
            }
        }
        
        async function saveBranding() {
            const title = document.getElementById('appTitle').value.trim();
            const subtitle = document.getElementById('appSubtitle').value.trim();
            const tempLogo = document.getElementById('logoPreview').src;
            if (!title) {
                showModal('Peringatan', 'Judul aplikasi tidak boleh kosong!');
                return;
            }

            const newSettings = {
                title: title,
                subtitle: subtitle,
                logo: tempLogo || 'default',
            };

            const result = await postDataToSheet('branding', 'save', newSettings);
            if (result.success) {
                showModal('Berhasil!', 'Pengaturan branding berhasil disimpan!');
                refreshData();
            }
        }

        async function saveSettings() {
            const newSettings = {
                workHourStart: document.getElementById('workHourStart').value,
                workHourEnd: document.getElementById('workHourEnd').value,
                lateTolerance: parseInt(document.getElementById('lateTolerance').value, 10)
            };

            const result = await postDataToSheet('settings', 'save', newSettings);
            if (result.success) {
                showModal('Berhasil!', 'Pengaturan sistem berhasil disimpan!');
                refreshData();
            }
        }

        async function deleteNews(newsId) {
            showModal('Konfirmasi', 'Apakah Anda yakin ingin menghapus berita ini?', true, async () => {
                const result = await postDataToSheet('news', 'delete', { id: newsId });
                if (result.success) {
                    showModal('Berhasil!', 'Berita berhasil dihapus.');
                    refreshData();
                }
            });
        }
        
        async function editAttendanceRecord(attendanceId) {
            const record = attendanceData.find(r => r.id == attendanceId);
            if (!record) return;
            document.getElementById('editAttendanceId').value = record.id;
            document.getElementById('editEmployeeName').value = record.employeeName;
            document.getElementById('editEmployeeEmail').value = record.employeeEmail;
            document.getElementById('editEmployeeDivision').value = record.employeeDivision;
            document.getElementById('editEmployeePosition').value = record.employeePosition;

            // Parse JSON strings
            const clockIn = record.clockIn ? JSON.parse(record.clockIn) : {};
            const clockOut = record.clockOut ? JSON.parse(record.clockOut) : null;

            if (clockIn.time) {
                const clockInTime = new Date(clockIn.time);
                document.getElementById('editClockInTime').value = clockInTime.toISOString().slice(0, 16);
                document.getElementById('editDutyAs').value = clockIn.dutyAs || '';
                document.getElementById('editWorkType').value = clockIn.workType || '';
                document.getElementById('editLocationIn').value = `${clockIn.location?.lat}, ${clockIn.location?.lng}`;
                document.getElementById('editRadiusStatusIn').value = clockIn.withinRadius.toString();
                document.getElementById('editOutsideReasonIn').value = clockIn.outsideReason || '';
                document.getElementById('editLateStatus').value = clockIn.isLate.toString();
                document.getElementById('editLateReason').value = clockIn.lateReason || '';
                document.getElementById('editPhotoIn').src = clockIn.photo || '';
            }

            if (clockOut) {
                const clockOutTime = new Date(clockOut.time);
                document.getElementById('editClockOutTime').value = clockOutTime.toISOString().slice(0, 16);
                document.getElementById('editLocationOut').value = `${clockOut.location?.lat}, ${clockOut.location?.lng}`;
                document.getElementById('editRadiusStatusOut').value = clockOut.withinRadius.toString();
                document.getElementById('editOutsideReasonOut').value = clockOut.outsideReason || '';
                document.getElementById('editWorkReport').value = clockOut.workReport || '';
                if (clockOut.workPhoto) {
                    document.getElementById('editPhotoOut').src = clockOut.workPhoto;
                    document.getElementById('editPhotoOut').classList.remove('hidden');
                    document.getElementById('editNoPhotoOut').classList.add('hidden');
                } else {
                    document.getElementById('editPhotoOut').classList.add('hidden');
                    document.getElementById('editNoPhotoOut').classList.remove('hidden');
                }
                document.getElementById('editClockOutSection').classList.remove('hidden');
            } else {
                document.getElementById('editClockOutSection').classList.add('hidden');
            }
            document.getElementById('editAdminNotes').value = record.adminNotes || '';
            document.getElementById('adminAttendanceEditModal').classList.remove('hidden');
            setupEditFormConditionals();
        }

        async function saveAttendanceEdit(e) {
            e.preventDefault();
            const attendanceId = document.getElementById('editAttendanceId').value;
            if (!attendanceId) return;
            
            const existingRecord = attendanceData.find(r => r.id == attendanceId);
            const clockIn = existingRecord.clockIn ? JSON.parse(existingRecord.clockIn) : {};
            const clockOut = existingRecord.clockOut ? JSON.parse(existingRecord.clockOut) : null;
            
            const locationInParts = document.getElementById('editLocationIn').value.split(',');
            const locationOutParts = document.getElementById('editLocationOut').value.split(',');

            const updatedRecord = {
                ...existingRecord,
                clockIn: JSON.stringify({
                    ...clockIn,
                    time: document.getElementById('editClockInTime').value,
                    dutyAs: document.getElementById('editDutyAs').value,
                    workType: document.getElementById('editWorkType').value,
                    location: {lat: parseFloat(locationInParts[0].trim()), lng: parseFloat(locationInParts[1].trim())},
                    withinRadius: document.getElementById('editRadiusStatusIn').value === 'true',
                    outsideReason: document.getElementById('editOutsideReasonIn').value || null,
                    isLate: document.getElementById('editLateStatus').value === 'true',
                    lateReason: document.getElementById('editLateReason').value || null,
                }),
                clockOut: document.getElementById('editClockOutTime').value ? JSON.stringify({
                    ...clockOut,
                    time: document.getElementById('editClockOutTime').value,
                    location: {lat: parseFloat(locationOutParts[0].trim()), lng: parseFloat(locationOutParts[1].trim())},
                    withinRadius: document.getElementById('editRadiusStatusOut').value === 'true',
                    outsideReason: document.getElementById('editOutsideReasonOut').value || null,
                    workReport: document.getElementById('editWorkReport').value,
                }) : null,
                adminNotes: document.getElementById('editAdminNotes').value || null,
                lastModified: new Date().toISOString(),
                modifiedBy: currentUser.email
            };

            const result = await postDataToSheet('attendance', 'save', updatedRecord);
            if (result.success) {
                hideAdminAttendanceEdit();
                showModal('Berhasil!', 'Data absensi berhasil diupdate!');
                refreshData();
            }
        }
        
        async function deleteAttendanceRecord(attendanceId) {
            showModal('Konfirmasi', `Apakah Anda yakin ingin menghapus data absensi ini?`, true, async () => {
                const result = await postDataToSheet('attendance', 'delete', { id: attendanceId });
                if (result.success) {
                    showModal('Berhasil!', 'Data absensi berhasil dihapus!');
                    refreshData();
                }
            });
        }
        
        // --- UI Rendering & Helper Functions ---
        function showClockInForm() {
            document.getElementById('clockInForm').classList.remove('hidden');
            document.getElementById('clockInBtn').disabled = true;
            if (currentUser) {
                document.getElementById('employeeName').value = currentUser.name || '';
                document.getElementById('employeeEmail').value = currentUser.email || '';
                document.getElementById('employeeDivision').value = currentUser.division || '';
                document.getElementById('employeePosition').value = currentUser.position || '';
                document.getElementById('employeeName').readOnly = true;
                document.getElementById('employeeEmail').readOnly = true;
                document.getElementById('employeeDivision').readOnly = true;
                document.getElementById('employeePosition').readOnly = true;
                document.getElementById('employeeName').classList.add('bg-gray-100');
                document.getElementById('employeeEmail').classList.add('bg-gray-100');
                document.getElementById('employeeDivision').classList.add('bg-gray-100');
                document.getElementById('employeePosition').classList.add('bg-gray-100');
            }
        }

        function hideClockInForm() {
            document.getElementById('clockInForm').classList.add('hidden');
            document.getElementById('clockInBtn').disabled = false;
            stopCamera();
            document.getElementById('employeeName').classList.remove('bg-gray-100');
            document.getElementById('employeeEmail').classList.remove('bg-gray-100');
            document.getElementById('employeeDivision').classList.remove('bg-gray-100');
            document.getElementById('employeePosition').classList.remove('bg-gray-100');
            document.getElementById('employeeName').readOnly = false;
            document.getElementById('employeeEmail').readOnly = false;
            document.getElementById('employeeDivision').readOnly = false;
            document.getElementById('employeePosition').readOnly = false;
        }

        function showClockOutForm() {
            document.getElementById('clockOutForm').classList.remove('hidden');
            document.getElementById('clockOutBtn').disabled = true;
        }

        function hideClockOutForm() {
            document.getElementById('clockOutForm').classList.add('hidden');
            document.getElementById('clockOutBtn').disabled = false;
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                const video = document.getElementById('cameraPreview');
                video.srcObject = stream;
                video.classList.remove('hidden');
                video.play();
                document.getElementById('captureBtn').classList.remove('hidden');
                window.currentStream = stream; // Store stream globally
            } catch (error) {
                showModal('Error', 'Tidak dapat mengakses kamera. Pastikan Anda memberikan izin kamera.');
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.getElementById('photoCanvas');
            const img = document.getElementById('capturedPhoto');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            img.src = canvas.toDataURL('image/jpeg');
            img.classList.remove('hidden');
            video.classList.add('hidden');
            document.getElementById('captureBtn').classList.add('hidden');
            document.getElementById('retakeBtn').classList.remove('hidden');
            stopCamera();
        }

        function retakePhoto() {
            document.getElementById('capturedPhoto').classList.add('hidden');
            document.getElementById('retakeBtn').classList.add('hidden');
            document.getElementById('photoCanvas').getContext('2d').clearRect(0, 0, document.getElementById('photoCanvas').width, document.getElementById('photoCanvas').height);
            startCamera();
        }

        function stopCamera() {
            if (window.currentStream) {
                window.currentStream.getTracks().forEach(track => track.stop());
                window.currentStream = null;
            }
        }

        function getCurrentLocation(type) {
            if (!navigator.geolocation) {
                showModal('Error', 'Geolocation tidak didukung oleh browser ini.');
                return;
            }
            const button = document.querySelector(`button[onclick="getCurrentLocation('${type}')"]`);
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Mendapatkan Lokasi...';
            button.disabled = true;
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    document.getElementById(`coords${type === 'in' ? 'In' : 'Out'}`).textContent = JSON.stringify({lat: latitude, lng: longitude});
                    displayLocationInfo(latitude, longitude, type);
                    button.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i>Lokasi Berhasil Didapat';
                    button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    button.classList.add('bg-green-600', 'hover:bg-green-700');
                },
                (error) => {
                    showModal('Error', 'Tidak dapat mendapatkan lokasi. Pastikan GPS aktif dan berikan izin lokasi.');
                    button.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i>Dapatkan Lokasi Saat Ini';
                    button.disabled = false;
                }
            );
        }

        function displayLocationInfo(lat, lng, type) {
            const coordsElement = document.getElementById(`coords${type === 'in' ? 'In' : 'Out'}`);
            const addressElement = document.getElementById(`address${type === 'in' ? 'In' : 'Out'}`);
            const radiusElement = document.getElementById(`radiusStatus${type === 'in' ? 'In' : 'Out'}`);
            const infoElement = document.getElementById(`location${type === 'in' ? 'In' : 'Out'}Info`);
            const reasonElement = document.getElementById(`outsideReason${type === 'in' ? 'In' : 'Out'}`);
            const mapElement = document.getElementById(`map${type === 'in' ? 'In' : 'Out'}`);
            coordsElement.textContent = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
            addressElement.textContent = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
            const withinRadius = isWithinOfficeRadius(lat, lng);
            if (withinRadius) {
                radiusElement.textContent = 'Anda berada dalam radius kantor';
                radiusElement.className = 'p-3 rounded-lg text-sm font-medium bg-green-100 text-green-800';
                reasonElement.classList.add('hidden');
            } else {
                radiusElement.textContent = 'Anda berada di luar radius kantor';
                radiusElement.className = 'p-3 rounded-lg text-sm font-medium bg-red-100 text-red-800';
                reasonElement.classList.remove('hidden');
            }
            displayMap(lat, lng, type, withinRadius);
            infoElement.classList.remove('hidden');
        }

        function displayMap(lat, lng, type, withinRadius) {
            const mapElement = document.getElementById(`map${type === 'in' ? 'In' : 'Out'}`);
            const mapHTML = `<div class="relative w-full h-full bg-blue-50 rounded-lg overflow-hidden"><div class="absolute inset-0 bg-gradient-to-br from-blue-100 to-green-100"></div><div class="absolute inset-0 opacity-20"><div class="grid grid-cols-8 grid-rows-6 h-full">${Array(48).fill().map(() => '<div class="border border-gray-300"></div>').join('')}</div></div>${officeLocations.map((office, index) => `<div class="absolute w-4 h-4 bg-blue-600 rounded-full border-2 border-white shadow-lg transform -translate-x-2 -translate-y-2" style="left: ${30 + index * 20}%; top: ${40 + index * 10}%;" title="Kantor ${index + 1}"><div class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white text-xs px-2 py-1 rounded whitespace-nowrap">Kantor ${index + 1}</div></div>`).join('')}${officeLocations.map((office, index) => `<div class="absolute border-2 border-blue-300 rounded-full opacity-30" style="left: ${25 + index * 20}%; top: ${35 + index * 10}%; width: 60px; height: 60px;"></div>`).join('')}<div class="absolute w-6 h-6 transform -translate-x-3 -translate-y-3" style="left: 50%; top: 50%;"><div class="w-full h-full ${withinRadius ? 'bg-green-500' : 'bg-red-500'} rounded-full border-3 border-white shadow-lg animate-pulse"></div><div class="absolute -top-10 left-1/2 transform -translate-x-1/2 ${withinRadius ? 'bg-green-600' : 'bg-red-600'} text-white text-xs px-2 py-1 rounded whitespace-nowrap"><i class="fas fa-map-marker-alt mr-1"></i>${withinRadius ? 'Dalam Radius' : 'Luar Radius'}</div></div><div class="absolute bottom-2 left-2 bg-white bg-opacity-90 px-2 py-1 rounded text-xs font-mono">${lat.toFixed(4)}, ${lng.toFixed(4)}</div><div class="absolute bottom-2 right-2 bg-white bg-opacity-90 px-2 py-1 rounded text-xs">${withinRadius ? 'Dalam radius kantor' : 'Di luar radius kantor'}</div></div>`;
            mapElement.innerHTML = mapHTML;
            mapElement.classList.remove('hidden', 'flex', 'items-center', 'justify-center');
        }

        function previewWorkPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showModal('Peringatan', 'Ukuran file terlalu besar. Maksimal 5MB.');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('workPhotoPreview');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function showTab(tabName) {
            document.getElementById('historyTab').classList.add('hidden');
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('border-transparent', 'text-gray-500');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('border-blue-500', 'text-blue-600');
        }

        function toggleProfileMenu() { document.getElementById('profileMenu').classList.toggle('hidden'); }
        function showProfileModal() {
            document.getElementById('profileMenu').classList.add('hidden');
            document.getElementById('profileModal').classList.remove('hidden');
            if (currentUser) {
                document.getElementById('profileName').value = currentUser.name || '';
                document.getElementById('profileEmail').value = currentUser.email || '';
                document.getElementById('profilePhone').value = currentUser.phone || '';
                document.getElementById('profileDepartment').value = currentUser.department || '';
                document.getElementById('profilePhotoPreview').src = currentUser.profilePhoto;
            }
        }
        function hideProfileModal() { document.getElementById('profileModal').classList.add('hidden'); }
        function previewProfilePhoto(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showModal('Peringatan', 'Ukuran file terlalu besar. Maksimal 5MB.');
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const src = e.target.result;
                    document.getElementById('profilePhotoPreview').src = src;
                    document.getElementById('userProfilePhoto').src = src;
                    currentUser.profilePhoto = src;
                };
                reader.readAsDataURL(file);
            }
        }

        function loadNews() {
            loadNewsPreview();
            if (isAdmin) loadNewsTable();
        }
        function loadNewsPreview() {
            const container = document.getElementById('newsPreviewContainer');
            const activeNews = newsData.filter(news => news.isActive);
            container.innerHTML = activeNews.map(news => {
                const categoryIcons = { 'HR': 'fas fa-gift text-green-600', 'Training': 'fas fa-graduation-cap text-purple-600', 'Announcement': 'fas fa-bullhorn text-blue-600', 'Event': 'fas fa-calendar text-orange-600', 'Policy': 'fas fa-file-alt text-gray-600', 'Safety': 'fas fa-shield-alt text-red-600' };
                const categoryColors = { 'HR': 'bg-green-100', 'Training': 'bg-purple-100', 'Announcement': 'bg-blue-100', 'Event': 'bg-orange-100', 'Policy': 'bg-gray-100', 'Safety': 'bg-red-100' };
                return `<div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200 cursor-pointer" onclick="showNewsDetail('${news.id}')"><div class="flex items-start"><div class="${categoryColors[news.category] || 'bg-gray-100'} p-2 rounded-lg mr-3 flex-shrink-0"><i class="${categoryIcons[news.category] || 'fas fa-newspaper text-gray-600'}"></i></div><div class="flex-1"><h3 class="font-medium text-gray-800 mb-1">${news.title}</h3><p class="text-sm text-gray-600 mb-2">${news.summary}</p><span class="text-xs text-blue-600 font-medium">${new Date(news.date).toLocaleDateString('id-ID')}</span></div></div></div>`;
            }).join('');
        }
        function updateNewsTicker() {
            const ticker = document.getElementById('newsTickerContent');
            const activeNews = newsData.filter(news => news.isActive && news.isNotified);
            const tickerContent = activeNews.map(news => {
                const emojis = { 'HR': '🎉', 'Training': '📚', 'Announcement': '📢', 'Event': '🎊', 'Policy': '📋', 'Safety': '⚠️' };
                return `${emojis[news.category] || '📰'} ${news.title}`;
            }).join(' • ');
            ticker.textContent = tickerContent || '📰 Tidak ada berita terbaru saat ini';
        }
        function loadNewsTable() {
            const tbody = document.getElementById('newsTableBody');
            if (!tbody) return;
            tbody.innerHTML = newsData.map(news => `
                <tr class="border-b border-gray-100">
                    <td class="py-3 px-4"><div class="font-medium text-gray-800">${news.title}</div><div class="text-sm text-gray-500">${news.summary}</div></td>
                    <td class="py-3 px-4"><span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">${news.category}</span></td>
                    <td class="py-3 px-4 text-sm text-gray-600">${new Date(news.date).toLocaleDateString('id-ID')}</td>
                    <td class="py-3 px-4"><span class="px-2 py-1 rounded-full text-xs font-medium ${news.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${news.isActive ? 'Aktif' : 'Nonaktif'}</span></td>
                    <td class="py-3 px-4"><span class="px-2 py-1 rounded-full text-xs font-medium ${news.isNotified ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">${news.isNotified ? 'Ya' : 'Tidak'}</span></td>
                    <td class="py-3 px-4"><div class="flex space-x-2"><button onclick="editNews('${news.id}')" class="text-blue-600 hover:text-blue-800" title="Edit"><i class="fas fa-edit"></i></button><button onclick="toggleNewsStatus('${news.id}')" class="text-yellow-600 hover:text-yellow-800" title="Toggle Status"><i class="fas fa-toggle-${news.isActive ? 'on' : 'off'}"></i></button><button onclick="toggleNewsNotification('${news.id}')" class="text-purple-600 hover:text-purple-800" title="Toggle Notifikasi"><i class="fas fa-bell${news.isNotified ? '' : '-slash'}"></i></button><button onclick="deleteNews('${news.id}')" class="text-red-600 hover:text-red-800" title="Hapus"><i class="fas fa-trash"></i></button></div></td>
                </tr>
            `).join('');
        }
        function loadEmployeeTable() {
            const tbody = document.getElementById('employeeTableBody');
            if (!tbody) return;
            tbody.innerHTML = allEmployees.map(emp => `
                <tr class="border-b border-gray-100">
                    <td class="py-3 px-4 font-medium text-gray-800">${emp.name}</td>
                    <td class="py-3 px-4 text-gray-600">${emp.email}</td>
                    <td class="py-3 px-4 text-gray-600">${emp.division}</td>
                    <td class="py-3 px-4 text-gray-600">${emp.position}</td>
                    <td class="py-3 px-4"><span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm">Aktif</span></td>
                </tr>
            `).join('');
        }
        function searchEmployees() {
            const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
            const tbody = document.getElementById('employeeTableBody');
            const filteredEmployees = allEmployees.filter(emp =>
                emp.name.toLowerCase().includes(searchTerm) ||
                emp.email.toLowerCase().includes(searchTerm) ||
                emp.division.toLowerCase().includes(searchTerm) ||
                emp.position.toLowerCase().includes(searchTerm)
            );
            tbody.innerHTML = filteredEmployees.map(emp => `
                <tr class="border-b border-gray-100">
                    <td class="py-3 px-4 font-medium text-gray-800">${emp.name}</td>
                    <td class="py-3 px-4 text-gray-600">${emp.email}</td>
                    <td class="py-3 px-4 text-gray-600">${emp.division}</td>
                    <td class="py-3 px-4 text-gray-600">${emp.position}</td>
                    <td class="py-3 px-4"><span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm">Aktif</span></td>
                </tr>
            `).join('');
        }
        function showNewsDetail(newsId) {
            const news = newsData.find(n => n.id == newsId);
            if (!news) return;
            const modal = document.getElementById('newsDetailModal');
            const title = document.getElementById('newsDetailTitle');
            const content = document.getElementById('newsDetailContent');
            title.textContent = news.title;
            content.innerHTML = `<div class="space-y-6"><div class="flex items-center justify-between"><div class="flex items-center space-x-4"><span class="px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">${news.category}</span><span class="text-sm text-gray-600">${new Date(news.date).toLocaleDateString('id-ID')}</span><span class="text-sm text-gray-600">oleh ${news.author}</span></div></div>${news.image ? `<div class="text-center"><img src="${news.image}" alt="${news.title}" class="w-full max-w-2xl mx-auto rounded-lg shadow-md"></div>` : ''}<div class="prose max-w-none"><div class="text-lg text-gray-800 leading-relaxed whitespace-pre-line">${news.content}</div></div></div>`;
            modal.classList.remove('hidden');
        }
        function hideNewsDetail() { document.getElementById('newsDetailModal').classList.add('hidden'); }
        function showAddNewsModal() {
            document.getElementById('newsModalTitle').textContent = 'Tambah Berita';
            document.getElementById('newsForm').reset();
            document.getElementById('newsId').value = '';
            document.getElementById('newsImagePreview').classList.add('hidden');
            document.getElementById('newsModal').classList.remove('hidden');
        }
        function hideNewsModal() { document.getElementById('newsModal').classList.add('hidden'); }
        function previewNewsImage(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { showModal('Peringatan', 'Ukuran file terlalu besar. Maksimal 5MB.'); return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('newsImagePreview').src = e.target.result;
                    document.getElementById('newsImagePreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        async function toggleNewsStatus(newsId) {
            const news = newsData.find(n => n.id == newsId);
            if (news) {
                const result = await postDataToSheet('news', 'save', { id: newsId, isActive: !news.isActive });
                if (result.success) refreshData();
            }
        }
        
        async function toggleNewsNotification(newsId) {
            const news = newsData.find(n => n.id == newsId);
            if (news) {
                const result = await postDataToSheet('news', 'save', { id: newsId, isNotified: !news.isNotified });
                if (result.success) refreshData();
            }
        }

        function showAdminTab(tabName) {
            document.querySelectorAll('[id$="Tab"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            if (tabName === 'attendance') {
                loadAttendanceHistory();
                setDefaultDateFilter();
            }
            if (tabName === 'branding') loadBrandingSettings();
            if (tabName === 'settings') loadSettings();
            updateAdminStats();
            document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                btn.classList.remove('border-purple-500', 'text-purple-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('border-transparent', 'text-gray-500');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('border-purple-500', 'text-purple-600');
        }

        function setDefaultDateFilter() {
            const today = new Date();
            const dateFilter = document.getElementById('attendanceDateFilter');
            if (dateFilter) dateFilter.value = today.toISOString().split('T')[0];
        }

        function loadAttendanceHistory() {
            const tbody = document.getElementById('attendanceHistoryTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (attendanceData.length === 0) {
                tbody.innerHTML = `<tr id="noAttendanceDataRow"><td colspan="7" class="py-8 px-4 text-center text-gray-500"><i class="fas fa-calendar-times text-4xl mb-2"></i><p>Belum ada data absensi</p></td></tr>`;
                return;
            }
            const sortedData = [...attendanceData].sort((a, b) => new Date(b.date) - new Date(a.date));
            sortedData.forEach(record => tbody.appendChild(createAttendanceRow(record)));
            updateFilterSummary(attendanceData.length, attendanceData.length);
        }

        function createAttendanceRow(record) {
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-100 hover:bg-gray-50 cursor-pointer';

            const clockIn = record.clockIn ? JSON.parse(record.clockIn) : null;
            const clockOut = record.clockOut ? JSON.parse(record.clockOut) : null;

            const timeIn = clockIn?.time ? new Date(clockIn.time).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-';
            const timeOut = clockOut?.time ? new Date(clockOut.time).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '-';
            
            let status = '';
            let statusClass = '';
            if (clockOut) {
                status = 'Hadir';
                statusClass = 'bg-green-100 text-green-800';
            } else if (clockIn?.isLate) {
                status = 'Terlambat';
                statusClass = 'bg-yellow-100 text-yellow-800';
            } else if (clockIn) {
                status = 'Clock In';
                statusClass = 'bg-blue-100 text-blue-800';
            }

            const locationStatus = (clockIn?.withinRadius && (!clockOut || clockOut?.withinRadius)) ? 'Dalam Radius' : 'Ada di Luar Radius';
            const locationClass = (clockIn?.withinRadius && (!clockOut || clockOut?.withinRadius)) ? 'text-green-600' : 'text-yellow-600';
            
            row.innerHTML = `<td class="py-3 px-4"><div class="font-medium text-gray-800">${record.employeeName}</div><div class="text-sm text-gray-500">${record.employeePosition}</div></td><td class="py-3 px-4">${new Date(record.date).toLocaleDateString('id-ID')}</td><td class="py-3 px-4">${timeIn}</td><td class="py-3 px-4">${timeOut}</td><td class="py-3 px-4"><span class="${statusClass} px-2 py-1 rounded-full text-sm">${status}</span></td><td class="py-3 px-4"><span class="text-sm ${locationClass}">${locationStatus}</span></td><td class="py-3 px-4"><div class="flex space-x-2"><button onclick="viewAttendanceDetail('${record.id}')" class="text-blue-600 hover:text-blue-800" title="Lihat Detail"><i class="fas fa-eye"></i></button><button onclick="editAttendanceRecord('${record.id}')" class="text-purple-600 hover:text-purple-800" title="Edit"><i class="fas fa-edit"></i></button><button onclick="deleteAttendanceRecord('${record.id}')" class="text-red-600 hover:text-red-800" title="Hapus"><i class="fas fa-trash"></i></button></div></td>`;
            return row;
        }

        function applyAttendanceFilter() {
            const nameFilter = document.getElementById('attendanceNameFilter').value.toLowerCase();
            const periodFilter = document.getElementById('attendancePeriodFilter').value;
            const dateFilter = document.getElementById('attendanceDateFilter').value;
            if (!dateFilter) {
                showModal('Peringatan', 'Silakan pilih tanggal untuk filter!');
                return;
            }
            const filterDate = new Date(dateFilter);
            let filteredData = [...attendanceData];
            if (nameFilter) {
                filteredData = filteredData.filter(record => record.employeeName.toLowerCase().includes(nameFilter) || record.employeeEmail.toLowerCase().includes(nameFilter) || record.employeePosition.toLowerCase().includes(nameFilter));
            }
            filteredData = filteredData.filter(record => {
                const recordDate = new Date(record.date);
                switch (periodFilter) {
                    case 'daily': return recordDate.toDateString() === filterDate.toDateString();
                    case 'weekly':
                        const weekStart = new Date(filterDate);
                        weekStart.setDate(filterDate.getDate() - filterDate.getDay());
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        return recordDate >= weekStart && recordDate <= weekEnd;
                    case 'monthly': return recordDate.getMonth() === filterDate.getMonth() && recordDate.getFullYear() === filterDate.getFullYear();
                    default: return true;
                }
            });
            const tbody = document.getElementById('attendanceHistoryTableBody');
            tbody.innerHTML = '';
            if (filteredData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="py-8 px-4 text-center text-gray-500"><i class="fas fa-search text-4xl mb-2"></i><p>Tidak ada data yang sesuai dengan filter</p></td></tr>`;
            } else {
                const sortedData = filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));
                sortedData.forEach(record => tbody.appendChild(createAttendanceRow(record)));
            }
            updateFilterSummary(filteredData.length, attendanceData.length);
        }

        function resetAttendanceFilter() {
            document.getElementById('attendanceNameFilter').value = '';
            document.getElementById('attendancePeriodFilter').value = 'daily';
            setDefaultDateFilter();
            document.getElementById('attendanceFilterSummary').classList.add('hidden');
            loadAttendanceHistory();
        }

        function updateFilterSummary(filteredCount, totalCount) {
            const summary = document.getElementById('attendanceFilterSummary');
            const summaryText = document.getElementById('filterSummaryText');
            const resultCount = document.getElementById('filterResultCount');
            if (filteredCount < totalCount) {
                const nameFilter = document.getElementById('attendanceNameFilter').value;
                const periodFilter = document.getElementById('attendancePeriodFilter').value;
                const dateFilter = document.getElementById('attendanceDateFilter').value;
                let filterText = `Filter aktif: ${periodFilter === 'daily' ? 'Harian' : periodFilter === 'weekly' ? 'Mingguan' : 'Bulanan'}`;
                if (dateFilter) filterText += ` (${new Date(dateFilter).toLocaleDateString('id-ID')})`;
                if (nameFilter) filterText += `, Nama: "${nameFilter}"`;
                summaryText.textContent = filterText;
                resultCount.textContent = `${filteredCount} dari ${totalCount} record`;
                summary.classList.remove('hidden');
            } else {
                summary.classList.add('hidden');
            }
        }

        function viewAttendanceDetail(attendanceId) {
            const record = attendanceData.find(r => r.id == attendanceId);
            if (!record) return;
            showAttendanceDetail(record);
        }

        function hideAdminAttendanceEdit() {
            document.getElementById('adminAttendanceEditModal').classList.add('hidden');
        }

        function setupEditFormConditionals() {
            const radiusIn = document.getElementById('editRadiusStatusIn');
            const outsideReasonInDiv = document.getElementById('editOutsideReasonInDiv');
            if (radiusIn) radiusIn.addEventListener('change', () => outsideReasonInDiv.classList.toggle('hidden', radiusIn.value === 'true'));
            const radiusOut = document.getElementById('editRadiusStatusOut');
            const outsideReasonOutDiv = document.getElementById('editOutsideReasonOutDiv');
            if (radiusOut) radiusOut.addEventListener('change', () => outsideReasonOutDiv.classList.toggle('hidden', radiusOut.value === 'true'));
            const lateStatus = document.getElementById('editLateStatus');
            const lateReasonDiv = document.getElementById('editLateReasonDiv');
            if (lateStatus) lateStatus.addEventListener('change', () => lateReasonDiv.classList.toggle('hidden', lateStatus.value === 'false'));
        }

        function showAttendanceDetail(data) {
            const modal = document.getElementById('attendanceDetailModal');
            const content = document.getElementById('attendanceDetailContent');
            let detailHTML = '';
            
            const clockIn = data.clockIn ? JSON.parse(data.clockIn) : null;
            const clockOut = data.clockOut ? JSON.parse(data.clockOut) : null;

            if (clockIn) {
                detailHTML += `<div class="bg-green-50 border border-green-200 rounded-xl p-6"><div class="flex items-center mb-4"><div class="bg-green-500 p-3 rounded-lg mr-4"><i class="fas fa-clock text-white text-xl"></i></div><div><h3 class="text-xl font-semibold text-green-800">Clock In</h3><p class="text-green-600">${new Date(clockIn.time).toLocaleString('id-ID')}</p></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label><p class="text-gray-900 bg-white p-3 rounded-lg border">${data.employeeName}</p></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Email</label><p class="text-gray-900 bg-white p-3 rounded-lg border">${data.employeeEmail}</p></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Divisi</label><p class="text-gray-900 bg-white p-3 rounded-lg border">${data.employeeDivision}</p></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Posisi</label><p class="text-gray-900 bg-white p-3 rounded-lg border">${data.employeePosition}</p></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Bertugas Sebagai</label><p class="text-gray-900 bg-white p-3 rounded-lg border">${clockIn.dutyAs || '-'}</p></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Jenis Pekerjaan</label><p class="text-gray-900 bg-white p-3 rounded-lg border">${clockIn.workType || '-'}</p></div></div><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">Lokasi</label><p class="text-gray-900 bg-white p-3 rounded-lg border font-mono text-sm">${clockIn.location?.lat?.toFixed(6)}, ${clockIn.location?.lng?.toFixed(6)}</p></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Status Radius</label><p class="p-3 rounded-lg border ${clockIn.withinRadius ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${clockIn.withinRadius ? 'Dalam Radius Kantor' : 'Di Luar Radius Kantor'}</p></div>${!clockIn.withinRadius ? `<div><label class="block text-sm font-medium text-gray-700 mb-1">Alasan di Luar Radius</label><p class="text-gray-900 bg-white p-3 rounded-lg border">${clockIn.outsideReason}</p></div>` : ''}<div><label class="block text-sm font-medium text-gray-700 mb-1">Status Keterlambatan</label><p class="p-3 rounded-lg border ${clockIn.isLate ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">${clockIn.isLate ? 'Terlambat' : 'Tepat Waktu'}</p></div>${clockIn.isLate ? `<div><label class="block text-sm font-medium text-gray-700 mb-1">Alasan Terlambat</label><p class="text-gray-900 bg-white p-3 rounded-lg border">${clockIn.lateReason}</p></div>` : ''}<div><label class="block text-sm font-medium text-gray-700 mb-1">Foto Masuk</label><div class="bg-white p-3 rounded-lg border"><img src="${clockIn.photo}" alt="Foto Masuk" class="w-full max-w-xs rounded-lg"></div></div></div></div></div>`;
            }
            if (clockOut) {
                detailHTML += `<div class="bg-red-50 border border-red-200 rounded-xl p-6 mt-6"><div class="flex items-center mb-4"><div class="bg-red-500 p-3 rounded-lg mr-4"><i class="fas fa-clock text-white text-xl"></i></div><div><h3 class="text-xl font-semibold text-red-800">Clock Out</h3><p class="text-red-600">${new Date(clockOut.time).toLocaleString('id-ID')}</p></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">Lokasi Pulang</label><p class="text-gray-900 bg-white p-3 rounded-lg border font-mono text-sm">${clockOut.location?.lat?.toFixed(6)}, ${clockOut.location?.lng?.toFixed(6)}</p></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Status Radius</label><p class="p-3 rounded-lg border ${clockOut.withinRadius ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${clockOut.withinRadius ? 'Dalam Radius Kantor' : 'Di Luar Radius Kantor'}</p></div>${!clockOut.withinRadius ? `<div><label class="block text-sm font-medium text-gray-700 mb-1">Alasan di Luar Radius</label><p class="text-gray-900 bg-white p-3 rounded-lg border">${clockOut.outsideReason}</p></div>` : ''}</div><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-1">Laporan Pekerjaan</label><p class="text-gray-900 bg-white p-3 rounded-lg border">${clockOut.workReport}</p></div>${clockOut.workPhoto ? `<div><label class="block text-sm font-medium text-gray-700 mb-1">Foto Pekerjaan</label><div class="bg-white p-3 rounded-lg border"><img src="${clockOut.workPhoto}" alt="Foto Pekerjaan" class="w-full max-w-xs rounded-lg"></div></div>` : ''}</div></div></div>`;
            }
            if (clockIn && clockOut) {
                const workTimeMs = new Date(clockOut.time) - new Date(clockIn.time);
                const workHours = Math.floor(workTimeMs / (1000 * 60 * 60));
                const workMinutes = Math.floor((workTimeMs % (1000 * 60 * 60)) / (1000 * 60));
                const workSeconds = Math.floor((workTimeMs % (1000 * 60)) / 1000);
                detailHTML += `<div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mt-6"><div class="flex items-center mb-4"><div class="bg-blue-500 p-3 rounded-lg mr-4"><i class="fas fa-chart-line text-white text-xl"></i></div><div><h3 class="text-xl font-semibold text-blue-800">Ringkasan Kerja</h3><p class="text-blue-600">Total waktu kerja hari ini</p></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div class="bg-white p-4 rounded-lg border text-center"><p class="text-sm text-gray-600 mb-1">Total Waktu Kerja</p><p class="text-2xl font-bold text-blue-600">${workHours}j ${workMinutes}m ${workSeconds}d</p></div><div class="bg-white p-4 rounded-lg border text-center"><p class="text-sm text-gray-600 mb-1">Status Masuk</p><p class="text-lg font-semibold ${clockIn.isLate ? 'text-yellow-600' : 'text-green-600'}">${clockIn.isLate ? 'Terlambat' : 'Tepat Waktu'}</p></div><div class="bg-white p-4 rounded-lg border text-center"><p class="text-sm text-gray-600 mb-1">Lokasi</p><p class="text-lg font-semibold ${clockIn.withinRadius && clockOut.withinRadius ? 'text-green-600' : 'text-yellow-600'}">${clockIn.withinRadius && clockOut.withinRadius ? 'Dalam Radius' : 'Ada di Luar Radius'}</p></div></div></div>`;
            }
            content.innerHTML = detailHTML;
            modal.classList.remove('hidden');
        }

        function hideAttendanceDetail() { document.getElementById('attendanceDetailModal').classList.add('hidden'); }

        function loadBrandingSettings() {
            document.getElementById('appTitle').value = appSettings.title || '';
            document.getElementById('appSubtitle').value = appSettings.subtitle || '';
            document.getElementById('logoPreview').src = appSettings.logo || '';
            document.getElementById('logoPreview').classList.toggle('hidden', appSettings.logo === 'default' || !appSettings.logo);
            updateLoginBranding();
            updateBrandingPreview();
        }

        function updateLoginBranding() {
            const loginTitle = document.getElementById('loginTitle');
            const loginSubtitle = document.getElementById('loginSubtitle');
            const loginLogoImg = document.getElementById('loginLogoImg');
            const loginLogoIcon = document.getElementById('loginLogoIcon');
            if (loginTitle) loginTitle.textContent = appSettings.title || 'ECrew Absensi';
            if (loginSubtitle) loginSubtitle.textContent = appSettings.subtitle || 'Transwisata Employee System';
            if (appSettings.logo && appSettings.logo !== 'default') {
                if (loginLogoImg) { loginLogoImg.src = appSettings.logo; loginLogoImg.classList.remove('hidden'); }
                if (loginLogoIcon) loginLogoIcon.classList.add('hidden');
            } else {
                if (loginLogoImg) loginLogoImg.classList.add('hidden');
                if (loginLogoIcon) loginLogoIcon.classList.remove('hidden');
            }
        }

        function updateBrandingPreview() {
            const previewTitle = document.getElementById('previewTitle');
            const previewSubtitle = document.getElementById('previewSubtitle');
            const previewLogoImg = document.getElementById('previewLogoImg');
            const previewLogoIcon = document.getElementById('previewLogoIcon');
            const currentLogoImg = document.getElementById('currentLogoImg');
            const currentLogoIcon = document.getElementById('currentLogoIcon');
            if (previewTitle) previewTitle.textContent = appSettings.title || 'ECrew Absensi';
            if (previewSubtitle) previewSubtitle.textContent = appSettings.subtitle || 'Transwisata Employee System';
            const logo = document.getElementById('logoPreview')?.src || appSettings.logo;
            if (logo && logo !== 'default') {
                if (previewLogoImg) { previewLogoImg.src = logo; previewLogoImg.classList.remove('hidden'); }
                if (previewLogoIcon) previewLogoIcon.classList.add('hidden');
                if (currentLogoImg) { currentLogoImg.src = logo; currentLogoImg.classList.remove('hidden'); }
                if (currentLogoIcon) currentLogoIcon.classList.add('hidden');
            } else {
                if (previewLogoImg) previewLogoImg.classList.add('hidden');
                if (previewLogoIcon) previewLogoIcon.classList.remove('hidden');
                if (currentLogoImg) currentLogoImg.classList.add('hidden');
                if (currentLogoIcon) currentLogoIcon.classList.remove('hidden');
            }
        }
        function previewLogo(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 2 * 1024 * 1024) { showModal('Peringatan', 'Ukuran file terlalu besar. Maksimal 2MB.'); return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('logoPreview').src = e.target.result;
                    document.getElementById('logoPreview').classList.remove('hidden');
                    updateBrandingPreview();
                };
                reader.readAsDataURL(file);
            }
        }

        function resetBranding() {
            showModal('Konfirmasi', 'Apakah Anda yakin ingin mereset ke pengaturan default?', true, async () => {
                const result = await postDataToSheet('branding', 'save', { title: 'ECrew Absensi', subtitle: 'Transwisata Employee System', logo: 'default' });
                if (result.success) {
                    document.getElementById('logoUpload').value = '';
                    document.getElementById('logoPreview').classList.add('hidden');
                    updateBrandingPreview();
                    showModal('Berhasil!', 'Pengaturan branding berhasil direset ke default!');
                }
            });
        }

        function loadSettings() {
            document.getElementById('workHourStart').value = systemSettings.workHourStart || '08:00';
            document.getElementById('workHourEnd').value = systemSettings.workHourEnd || '17:00';
            document.getElementById('lateTolerance').value = systemSettings.lateTolerance || 15;
        }

        function updateAdminStats() {
            const today = new Date().toISOString().split('T')[0];
            const presentToday = attendanceData.filter(record => record.date === today && record.clockIn).length;
            const lateToday = attendanceData.filter(record => record.date === today && JSON.parse(record.clockIn)?.isLate).length;
            document.getElementById('totalEmployees').textContent = allEmployees.length;
            document.getElementById('presentToday').textContent = presentToday;
            document.getElementById('lateToday').textContent = lateToday;
            document.getElementById('absentToday').textContent = allEmployees.length - presentToday;
        }
        function downloadAttendancePDF(period) {
            const data = attendanceData;
            const periodFilter = period;
            const filterDate = new Date();
            const nameFilter = '';
            generatePDF(data, periodFilter, filterDate, nameFilter);
        }

        function generatePDF(data, periodFilter, filterDate, nameFilter) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape', 'mm', 'a4');
            doc.setFont('helvetica');
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            const title = 'Rekap Absensi Karyawan PT. Transwisata Prima Aviation';
            const titleWidth = doc.getTextWidth(title);
            const pageWidth = doc.internal.pageSize.getWidth();
            doc.text(title, (pageWidth - titleWidth) / 2, 20);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            let dateRangeText = '';
            switch (periodFilter) {
                case 'daily': dateRangeText = `Tanggal: ${formatIndonesianDate(filterDate)}`; break;
                case 'weekly':
                    const weekStart = new Date(filterDate);
                    weekStart.setDate(filterDate.getDate() - filterDate.getDay());
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    dateRangeText = `Periode: ${formatIndonesianDate(weekStart)} - ${formatIndonesianDate(weekEnd)}`;
                    break;
                case 'monthly':
                    const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                    dateRangeText = `Bulan: ${monthNames[filterDate.getMonth()]} ${filterDate.getFullYear()}`;
                    break;
            }
            if (nameFilter) { dateRangeText += ` | Filter Nama: "${nameFilter}"`; }
            const dateRangeWidth = doc.getTextWidth(dateRangeText);
            doc.text(dateRangeText, (pageWidth - dateRangeWidth) / 2, 30);
            const now = new Date();
            const generateTime = `Dibuat pada: ${formatIndonesianDateTime(now)}`;
            const generateTimeWidth = doc.getTextWidth(generateTime);
            doc.text(generateTime, (pageWidth - generateTimeWidth) / 2, 40);
            let currentY = 50;
            if (nameFilter) {
                const uniqueEmployees = [...new Set(data.map(record => record.employeeName))];
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('Karyawan:', 15, currentY);
                doc.setFont('helvetica', 'normal');
                const employeeText = uniqueEmployees.join(', ');
                doc.text(employeeText, 15, currentY + 7);
                currentY += 20;
            }
            const tableData = [];
            const sortedData = data.sort((a, b) => new Date(b.date) - new Date(a.date));
            sortedData.forEach(record => {
                const clockIn = record.clockIn ? JSON.parse(record.clockIn) : null;
                const clockOut = record.clockOut ? JSON.parse(record.clockOut) : null;
                const clockInTime = clockIn?.time ? formatTime(clockIn.time) : '-';
                const clockOutTime = clockOut?.time ? formatTime(clockOut.time) : '-';
                let totalTime = '-';
                if (clockIn && clockOut) {
                    const workTimeMs = new Date(clockOut.time) - new Date(clockIn.time);
                    const hours = Math.floor(workTimeMs / (1000 * 60 * 60));
                    const minutes = Math.floor((workTimeMs % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((workTimeMs % (1000 * 60)) / 1000);
                    totalTime = `${hours}j ${minutes}m ${seconds}d`;
                }
                let status = clockOut ? 'Hadir' : (clockIn?.isLate ? 'Terlambat' : 'Clock In');
                const workReport = clockOut?.workReport ? clockOut.workReport.substring(0, 50) + (clockOut.workReport.length > 50 ? '...' : '') : '-';
                tableData.push([
                    formatIndonesianDate(new Date(record.date)),
                    record.employeeDivision || '-',
                    record.employeePosition || '-',
                    clockIn?.dutyAs || '-',
                    clockIn?.workType || '-',
                    status,
                    clockInTime,
                    clockOutTime,
                    totalTime,
                    workReport
                ]);
            });
            const headers = ['DATE', 'DIVISION', 'POSITION', 'DUTY AS', 'TYPE OF WORK', 'STATUS ABSEN', 'ABSEN MASUK', 'ABSEN PULANG', 'TOTAL TIME', 'REMARKS PEKERJAAN'];
            doc.autoTable({
                head: [headers],
                body: tableData,
                startY: currentY,
                styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak', halign: 'center' },
                headStyles: { fillColor: [79, 70, 229], textColor: 255, fontStyle: 'bold', halign: 'center' },
                columnStyles: { 0: { cellWidth: 25 }, 1: { cellWidth: 25 }, 2: { cellWidth: 30 }, 3: { cellWidth: 25 }, 4: { cellWidth: 25 }, 5: { cellWidth: 20 }, 6: { cellWidth: 20 }, 7: { cellWidth: 20 }, 8: { cellWidth: 20 }, 9: { cellWidth: 40, halign: 'left' } },
                alternateRowStyles: { fillColor: [245, 245, 245] },
                margin: { top: currentY, left: 10, right: 10 }
            });
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Halaman ${i} dari ${pageCount}`, pageWidth - 30, doc.internal.pageSize.getHeight() - 10);
            }
            const dateStr = filterDate.toISOString().split('T')[0];
            const periodStr = periodFilter === 'daily' ? 'Harian' : periodFilter === 'weekly' ? 'Mingguan' : 'Bulanan';
            const nameStr = nameFilter ? `_${nameFilter.replace(/\s+/g, '_')}` : '';
            const filename = `Rekap_Absensi_${periodStr}_${dateStr}${nameStr}.pdf`;
            doc.save(filename);
        }

        function formatIndonesianDate(date) {
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            return `${day} ${month} ${year}`;
        }

        function formatIndonesianDateTime(date) {
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
        }

        function formatTime(dateTime) {
            const date = new Date(dateTime);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }
    </script>
</body>
</html>
